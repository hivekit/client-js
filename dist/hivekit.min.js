var h=class{constructor(){this.listener={},this.listenerId=0}on(e,s,i,n){return this.listenerId++,this.listener[e]||(this.listener[e]=[]),this.listener[e].push({eventName:e,fn:s,context:i,order:n,id:this.listenerId}),this.listener[e].sort((o,r)=>o.order==r.order?0:o.order>r.order?1:-1),this.listenerId}off(e,s,i){if(!!this.listener[e]){for(var n=this.listener[e].length;n--;)this.listener[e][n].fn===s&&this.listener[e][n].context===i&&this.listener[e].splice(n,1);this.listener[e].length===0&&delete this.listener[e]}}removeListenerById(e,s){if(!this.listener[e])throw new Error("No listener registered for eventname "+e);var i=!1;if(this.listener[e]=this.listener[e].filter(n=>n.id===s?(i=!0,!1):!0),!i)throw new Error(`Failed to find listener with id ${s} for event ${e}`)}emit(e){if(!this.listener[e])return;let s=Array.prototype.slice.call(arguments,1);for(var i=null,n=0;this.listener[e]&&this.listener[e][n];){if(i=this.listener[e][n],this.listener[e][n].fn.apply(this.listener[e][n].context,s)===!1)return;this.listener[e]&&this.listener[e][n]===i&&n++}}hasListeners(e){return!!(this.listener[e]&&this.listener[e].length>0)}};var t={CONNECTION_STATUS:{CONNECTED:"connected",DISCONNECTED:"disconnected",CONNECTING:"connecting",DISCONNECTING:"disconnecting",AUTHENTICATED:"authenticated"},TYPE:{REALM:"rea",OBJECT:"obj",AREA:"are",SUBSCRIPTION:"sub",SYSTEM:"sys",INSTRUCTION:"ins",LOGEVENT:"log"},UPDATE_TYPE:{FULL:"ful",DELTA:"dta"},STRING_VALUE:"val",INTERNAL_EVENTS:["connectionStatusChanged"],FIELD:{TYPE:"typ",SCOPE_TYPE:"sty",SUB_TYPE:"sty",SCOPE_ID:"sid",EXECUTE_IMMEDIATELY:"exe",ACTION:"act",RESULT:"res",CORRELATION_ID:"cid",ID:"id",REALM:"rea",DATA:"dat",LOCATION:"loc",ERROR:"err",LABEL:"lab",ATTRIBUTE:"atr",UPDATE_TYPE:"uty",INSTRUCTION_STRING:"ins",PRESENCE_CONNECTION_STATUS:"cst",SHAPE:"sha",SHAPE_DATA:"shapeData",FIELD:"fie",VALUE:"val",START:"sta",END:"end",LEVEL:"lvl",EVENT_NAME:"eve",ID_PATTERN:"idp"},ACTION:{CREATE:"cre",READ:"rea",LIST:"lis",UPDATE:"upd",DELETE:"del",AUTHENTICATE:"aut",SET:"set",SEARCH:"sea",HEARTBEAT:"hbt",SUBSCRIBE:"sub",UNSUBSCRIBE:"uns",PUBLISH:"pub"},RESULT:{SUCCESS:"suc",WARNING:"war",ERROR:"err"},SUBSCRIPTION:{REALM:"all-realms"},LOCATION:{GEOGRAPHIC_COORDINATE_SYSTEM:"gcs",LONGITUDE:"lon",LATITUDE:"lat",ACCURACY:"acc",SPEED:"spe",HEADING:"hea",ALTITUDE:"alt",ALTITUDE_ACCURACY:"alc",TIME:"tim"},SHAPE_TYPE:{RECTANGLE:"rec",CIRCLE:"cir",POLYGON:"pol"},PRESENCE_CONNECTION_STATUS:{CONNECTED:"con",DISCONNECTED:"dis"}};var A=class{constructor(e){this._client=e,this._systemUpdateSubscription=null}getHttpUrl(){return document.location.protocol+"//"+new URL(this._client._wsConnection.url).host}authenticateAdmin(e){return new Promise(async(s,i)=>{let n=this.getHttpUrl()+this._client.options.adminDashboardBasePath+"api/authenticate-admin";var o;try{o=await fetch(n,{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:"admin",password:e})})}catch(r){i(r.message);return}if(o.status===200)s();else{let r=await o.json();i(r[0][t.FIELD.ERROR])}})}_sendAuthMessage(e){this._client._wsConnection.readyState===this._client._wsConnection.constructor.OPEN?this._client._wsConnection.send("Bearer "+e):this._client._wsConnection.addEventListener("open",()=>{this._client._wsConnection.send("Bearer "+e)})}_handleIncomingMessage(e){switch(e[t.FIELD.ACTION]){case t.ACTION.AUTHENTICATE:e[t.FIELD.RESULT]===t.RESULT.SUCCESS&&(this._client._changeConnectionStatus(t.CONNECTION_STATUS.AUTHENTICATED),this._client._onAuthenticatePromise&&this._client._onAuthenticatePromise.resolve()),e[t.FIELD.RESULT]===t.RESULT.ERROR&&this._client._onAuthenticatePromise&&this._client._onAuthenticatePromise.reject(e[t.FIELD.DATA]);break;default:this._client._onError(`Unknown action for type ${t.TYPE.SYSTEM}: ${e[t.FIELD.ACTION]}`)}}};function T(){var E,e;let s=new Promise((i,n)=>{E=i,e=n});return s.resolve=E,s.reject=e,s}function l(E,e,s,i,n,o){let r={[t.FIELD.TYPE]:E,[t.FIELD.ACTION]:e};return s&&(r[t.FIELD.ID]=s),i&&(r[t.FIELD.REALM]=i),n&&(r[t.FIELD.DATA]=n),o&&(r[t.FIELD.LOCATION]=o),r}var c={TYPE:{[t.TYPE.REALM]:"realm",[t.TYPE.OBJECT]:"object",[t.TYPE.AREA]:"area",[t.TYPE.SUBSCRIPTION]:"subscription",[t.TYPE.SYSTEM]:"system",[t.TYPE.INSTRUCTION]:"instruction",[t.TYPE.LOGEVENT]:"logEvent"},FIELD:{[t.FIELD.TYPE]:"type",[t.FIELD.SCOPE_TYPE]:"scopeType",[t.FIELD.ACTION]:"action",[t.FIELD.RESULT]:"result",[t.FIELD.CORRELATION_ID]:"correlationId",[t.FIELD.ID]:"id",[t.FIELD.REALM]:"realm",[t.FIELD.DATA]:"data",[t.FIELD.LOCATION]:"location",[t.FIELD.ERROR]:"error",[t.FIELD.LABEL]:"label",[t.FIELD.ATTRIBUTE]:["attribute","where"],[t.FIELD.EXECUTE_IMMEDIATELY]:"executeImmediately",[t.FIELD.SHAPE]:"shape",[t.FIELD.SHAPE_DATA]:"shapeData",[t.FIELD.INSTRUCTION_STRING]:"instructionString",[t.FIELD.FIELD]:"field",[t.FIELD.VALUE]:"value",[t.FIELD.START]:"start",[t.FIELD.END]:"end",[t.FIELD.LEVEL]:"level",[t.FIELD.PRESENCE_CONNECTION_STATUS]:"connectionStatus"},PRESENCE_CONNECTION_STATUS:{[t.PRESENCE_CONNECTION_STATUS.CONNECTED]:"connected",[t.PRESENCE_CONNECTION_STATUS.DISCONNECTED]:"disconnected"},ACTION:{[t.ACTION.CREATE]:"create",[t.ACTION.READ]:"read",[t.ACTION.LIST]:"list",[t.ACTION.UPDATE]:"update",[t.ACTION.DELETE]:"delete",[t.ACTION.AUTHENTICATE]:"authenticate",[t.ACTION.SET]:"set"},RESULT:{[t.RESULT.SUCCESS]:"success",[t.RESULT.WARNING]:"warning",[t.RESULT.ERROR]:"error"},LOCATION:{[t.LOCATION.GEOGRAPHIC_COORDINATE_SYSTEM]:"coordinateSystem",[t.LOCATION.LONGITUDE]:"longitude",[t.LOCATION.LATITUDE]:"latitude",[t.LOCATION.ACCURACY]:"accuracy",[t.LOCATION.SPEED]:"speed",[t.LOCATION.HEADING]:"heading",[t.LOCATION.ALTITUDE]:"altitude",[t.LOCATION.ALTITUDE_ACCURACY]:"altitudeAccuracy",[t.LOCATION.TIME]:"time"},SHAPE_TYPE:{[t.SHAPE_TYPE.RECTANGLE]:"rectangle",[t.SHAPE_TYPE.CIRCLE]:"circle",[t.SHAPE_TYPE.POLYGON]:"polygon"}};function F(E){let e={};for(var s in E)E[s]instanceof Array?E[s].forEach(i=>{e[i]=s}):e[E[s]]=s;return e}function _(E,e){for(var s in e)E[s]=e[s];return E}function P(E){return JSON.parse(JSON.stringify(E))}var C=class{constructor(e,s){this._client=e,this._realm=s,this._locationFields=this._getLocationFields()}subscribe(e){if(e&&e.shape)switch(Object.keys(e.shape).sort().join("")){case"x1x2y1y2":e.scopeType=t.SHAPE_TYPE.RECTANGLE;break;case"cxcyr":e.scopeType=t.SHAPE_TYPE.CIRCLE;break;case"points":e.scopeType=t.SHAPE_TYPE.POLYGON;break;default:throw new Error("Unknown shape data")}return this._client._subscription._getSubscription(this._client.getId("object-subscription"),this._realm.id,_({[t.FIELD.TYPE]:t.TYPE.OBJECT,[t.FIELD.SCOPE_TYPE]:t.TYPE.REALM},this._client._compressFields(e,c.FIELD)))}get(e){if(!e)throw new Error("no id provided for object.get");let s=l(t.TYPE.OBJECT,t.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s,i=>this._client._extendFields(i[t.FIELD.DATA]))}create(e,s,i,n){return this._setObjectState(e,s,i,n,t.ACTION.CREATE)}update(e,s,i,n){return this._setObjectState(e,s,i,n,t.ACTION.UPDATE)}set(e,s,i,n){this._setObjectState(e,s,i,n,t.ACTION.SET)}list(e){let s=l(t.TYPE.OBJECT,t.ACTION.LIST,null,this._realm.id);return e&&Object.keys(e).length>0&&(s[t.FIELD.DATA]=this._client._compressFields(e,c.FIELD)),this._client._sendRequestAndHandleResponse(s,i=>this._client._extendFieldsMap(i[t.FIELD.DATA]))}delete(e){let s=l(t.TYPE.OBJECT,t.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s)}_getLocationFields(){let e={};for(var s in c.LOCATION)e[c.LOCATION[s]]=s;return e}_setObjectState(e,s,i,n,o){let r=l(t.TYPE.OBJECT,o,e,this._realm.id);if(s&&(r[t.FIELD.LABEL]=s),i&&Object.keys(i).length>0&&(r[t.FIELD.LOCATION]=this._parseLocation(i)),n&&Object.keys(n).length>0&&(r[t.FIELD.DATA]=n),o===t.ACTION.SET)this._client._sendMessage(r);else return this._client._sendRequestAndHandleResponse(r)}_parseLocation(e){let s={};for(var i in e)if(i.length!==0){if(typeof e[i]!="string"){s[this._locationFields[i]]=e[i];continue}if(e[i].length>0)if(i===c.LOCATION[t.LOCATION.TIME])try{s[i]=new Date(e[i]).toISOString()}catch(n){throw new Error(`Can't convert ${e[i]} into a valid date:${n}`)}else s[this._locationFields[i]]=parseFloat(e[i])}return s}};var p=class{constructor(e,s){this._client=e,this._realm=s}subscribe(e){return this._client._subscription._getSubscription(this._client.getId("area-subscription"),this._realm.id,_({[t.FIELD.TYPE]:t.TYPE.AREA,[t.FIELD.SCOPE_TYPE]:t.TYPE.REALM},this._client._compressFields(e,c.FIELD)))}get(e){let s=l(t.TYPE.AREA,t.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s,i=>this._client._extendFields(i[t.FIELD.DATA]))}create(e,s,i,n){return this._setAreaState(e,s,i,n,t.ACTION.CREATE)}update(e,s,i,n){return this._setAreaState(e,s,i,n,t.ACTION.UPDATE)}list(){let e=l(t.TYPE.AREA,t.ACTION.LIST,null,this._realm.id);return this._client._sendRequestAndHandleResponse(e,s=>{let i=this._client._extendFieldsMap(s[t.FIELD.DATA]);for(var n in i)i[n].shape=c.SHAPE_TYPE[i[n].scopeType],delete i[n].scopeType;return i})}delete(e){let s=l(t.TYPE.AREA,t.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s)}_setAreaState(e,s,i,n,o){let r=l(t.TYPE.AREA,o,e,this._realm.id);switch(s&&(r[t.FIELD.LABEL]=s),n&&(r[t.FIELD.DATA]=n),Object.keys(i).sort().join("")){case"x1x2y1y2":r[t.FIELD.SUB_TYPE]=t.SHAPE_TYPE.RECTANGLE;break;case"cxcyr":r[t.FIELD.SUB_TYPE]=t.SHAPE_TYPE.CIRCLE;break;case"points":r[t.FIELD.SUB_TYPE]=t.SHAPE_TYPE.POLYGON;break;default:return new Promise((N,f)=>{f("unknown shape data")})}return r[t.FIELD.SHAPE]=i,this._client._sendRequestAndHandleResponse(r)}};var L=class{constructor(e,s){this._client=e,this._realm=s}subscribe(e){return this._client._subscription._getSubscription(this._client.getId("instruction-subscription"),this._realm.id,_({[t.FIELD.TYPE]:t.TYPE.INSTRUCTION,[t.FIELD.SCOPE_TYPE]:t.TYPE.REALM},this._client._compressFields(e,c.FIELD)))}subscribeToLogs(e){return this._client._subscription._getSubscription(this._client.getId("instruction-log-subscription"),this._realm.id,_({[t.FIELD.TYPE]:t.TYPE.LOGEVENT,[t.FIELD.SCOPE_TYPE]:t.TYPE.REALM},this._client._compressFields(e,c.FIELD)))}get(e){let s=l(t.TYPE.INSTRUCTION,t.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s,i=>this._client._extendFields(i[t.FIELD.DATA]))}create(e,s,i,n){return this._setInstructionState(e,s,i,n,t.ACTION.CREATE)}update(e,s,i,n){return this._setInstructionState(e,s,i,n,t.ACTION.UPDATE)}list(){let e=l(t.TYPE.INSTRUCTION,t.ACTION.LIST,null,this._realm.id);return this._client._sendRequestAndHandleResponse(e,s=>this._client._extendFieldsMap(s[t.FIELD.DATA]))}delete(e){let s=l(t.TYPE.INSTRUCTION,t.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(s)}_setInstructionState(e,s,i,n,o){let r=l(t.TYPE.INSTRUCTION,o,e,this._realm.id);return r[t.FIELD.INSTRUCTION_STRING]=i,s&&(r[t.FIELD.LABEL]=s),n&&(r[t.FIELD.DATA]=n),this._client._sendRequestAndHandleResponse(r)}};var D=class{constructor(e,s){this._client=e,this._realm=s,this._subscriptionCallbacks=[]}subscribe(e,s,i){var n=null;return arguments.length==2?i=s:n=s,this._subscriptionCallbacks[e]=i,this._client._sendRequestAndHandleResponse(this._getPubSubMessage(t.ACTION.SUBSCRIBE,e,n))}unsubscribe(e,s){return delete this._subscriptionCallbacks[e],this._client._sendRequestAndHandleResponse(this._getPubSubMessage(t.ACTION.UNSUBSCRIBE,e,s))}publish(e,s,i){var n;arguments.length==2?(n="*",i=s):n=s;let o=this._getPubSubMessage(t.ACTION.PUBLISH,e,n);return o[t.FIELD.DATA][t.FIELD.DATA]=i,this._client._sendRequestAndHandleResponse(o)}_emitSubscriptionEvent(e,s,i){this._subscriptionCallbacks[e]&&(t.INTERNAL_EVENTS.includes(e)&&(s=this._client._extendFields(s)),this._subscriptionCallbacks[e](s,i))}_getPubSubMessage(e,s,i){let n=l(t.TYPE.REALM,e,this._realm.id);return n[t.FIELD.DATA]={[t.FIELD.EVENT_NAME]:s,[t.FIELD.ID_PATTERN]:i||"*"},n}};var S=class extends h{constructor(e,s,i,n){super();this._client=n,this._data=i,this._subscriptionCallbacks={},this.id=e,this.label=s,this.object=new C(n,this),this.area=new p(n,this),this.instruction=new L(n,this),this.pubsub=new D(n,this)}getData(e){return e?typeof this._data[e]=="object"?P(this._data[e]):this._data[e]:P(this._data)}setData(e,s){let i=l(t.TYPE.REALM,t.ACTION.UPDATE,this.id);return this._data[e]=s,i[t.FIELD.DATA]=this._data,this.emit("update"),this._client._sendRequestAndHandleResponse(i)}setLabel(e){let s=l(t.TYPE.REALM,t.ACTION.UPDATE,this.id);return this.label=e,s[t.FIELD.LABEL]=e,this.emit("update"),this._client._sendRequestAndHandleResponse(s)}search(e,s){let i=this._client._compressFields(s,c.FIELD,!0);i[t.STRING_VALUE]=e;let n=l(t.TYPE.REALM,t.ACTION.SEARCH,null,this.id,i);return this._client._sendRequestAndHandleResponse(n,o=>o[t.FIELD.DATA]?o[t.FIELD.DATA].map(r=>{let a=this._client._extendFields(r);return a.dataProperty=a.scopeType,delete a.scopeType,a}):[])}};var O=class{constructor(e){this._client=e,this._realms={}}subscribe(){return this._client._subscription._getSubscription(this._client.getId("realm-subscription-"),t.TYPE.SYSTEM,{[t.FIELD.TYPE]:t.TYPE.SYSTEM,[t.FIELD.SCOPE_TYPE]:t.TYPE.REALM})}get(e){if(this._realms[e]){let i=T();return i.resolve(this._realms[e]),i}let s=l(t.TYPE.REALM,t.ACTION.READ,e);return this._client._sendRequestAndHandleResponse(s,i=>(this._realms[e]=new S(e,i[t.FIELD.DATA][t.FIELD.LABEL],i[t.FIELD.DATA][t.FIELD.DATA]||{},this._client),this._realms[e]))}create(e,s,i){let n=l(t.TYPE.REALM,t.ACTION.CREATE,e);return s&&(n[t.FIELD.LABEL]=s),i&&Object.keys(i).length>0&&(n[t.FIELD.DATA]=i),this._client._sendRequestAndHandleResponse(n)}list(){let e=l(t.TYPE.REALM,t.ACTION.LIST);return this._client._sendRequestAndHandleResponse(e,s=>this._client._extendFieldsMap(s.dat))}delete(e){let s=l(t.TYPE.REALM,t.ACTION.DELETE,e);return this._client._sendRequestAndHandleResponse(s)}_handleIncomingMessage(e){e[t.FIELD.ACTION]==t.ACTION.PUBLISH&&this._realms[e[t.FIELD.REALM]]&&this._realms[e[t.FIELD.REALM]].pubsub._emitSubscriptionEvent(e[t.FIELD.DATA][t.FIELD.EVENT_NAME],e[t.FIELD.DATA][t.FIELD.DATA],e[t.FIELD.DATA][t.FIELD.ID_PATTERN])}};var m=(E=21)=>{let e="",s=crypto.getRandomValues(new Uint8Array(E));for(;E--;){let i=s[E]&63;i<36?e+=i.toString(36):i<62?e+=(i-26).toString(36).toUpperCase():i<63?e+="_":e+="-"}return e};var I=class extends h{constructor(e,s,i){super();this.id=s,this.realmId=i,this._client=e,this._data=null}cancel(){return this._client._subscription._removeSubscription(this)}_processIncomingMessage(e){let s={};switch(e[t.TYPE.OBJECT]?s=this._client._extendFieldsMap(e[t.TYPE.OBJECT]):e[t.TYPE.AREA]?s=this._client._extendFieldsMap(e[t.TYPE.AREA]):e[t.TYPE.INSTRUCTION]?s=this._client._extendFieldsMap(e[t.TYPE.INSTRUCTION]):e[t.TYPE.LOGEVENT]?s=this._client._extendFieldsArray(e[t.TYPE.LOGEVENT]):e[t.FIELD.DATA]&&e[t.FIELD.DATA][t.FIELD.TYPE]===t.TYPE.REALM&&(s={realmId:e[t.FIELD.DATA][t.FIELD.ID],action:c.ACTION[e[t.FIELD.DATA][t.FIELD.ACTION]]}),e[t.FIELD.UPDATE_TYPE]){case t.UPDATE_TYPE.FULL:this._data=s;break;case t.UPDATE_TYPE.DELTA:for(var i in s)this._data[i]=s[i];break;default:this._client._onError("Received subscription message with unknown update type "+e[t.FIELD.UPDATE_TYPE]);return}this.emit("update",this._data)}};var R=class{constructor(e){this._client=e,this._subscriptionCollections={},this._pendingSubscriptionPromises={}}_getSubscription(e,s,i){let n=T(),o=this._client._getSignature(s,i);var r,a=this._subscriptionCollections[e];if(!a)for(var N in this._subscriptionCollections)this._subscriptionCollections[N].signature===o&&(e=N,a=this._subscriptionCollections[e]);if(a)return r=new I(this._client,e,s),a.push(r),n.resolve(r),i[t.FIELD.EXECUTE_IMMEDIATELY]&&this._invokeImmediatly(r),n;if(e||(e=this.getId(this.constants.TYPE.SUBSCRIPTION)),r=new I(this._client,e,s),this._subscriptionCollections[e]=[r],this._subscriptionCollections[e].signature=o,this._pendingSubscriptionPromises[o])return this._pendingSubscriptionPromises[o].push({resultPromise:n,subscription:r}),n;this._pendingSubscriptionPromises[o]=[{resultPromise:n,subscription:r}];let f=l(t.TYPE.SUBSCRIPTION,t.ACTION.CREATE,e,s,i);return this._client._sendRequest(f,g=>{g[t.FIELD.RESULT]===t.RESULT.SUCCESS?this._pendingSubscriptionPromises[o].forEach(d=>{d.resultPromise.resolve(d.subscription)}):this._pendingSubscriptionPromises[o].forEach(d=>{d.resultPromise.reject(g[t.FIELD.ERROR])}),delete this._pendingSubscriptionPromises[o]}),n}_removeSubscription(e){if(!this._subscriptionCollections[e.id])throw new Error("Can`t remove unknown subscription "+e.id);if(!this._subscriptionCollections[e.id].includes(e))throw new Error("Subscription not found for id "+e.id);if(this._subscriptionCollections[e.id]=this._subscriptionCollections[e.id].filter(i=>e!==i),this._subscriptionCollections[e.id].length>0)return new Promise(i=>{i()});let s=l(t.TYPE.SUBSCRIPTION,t.ACTION.DELETE,e.id,e.realmId);return delete this._subscriptionCollections[e.id],this._client._sendRequestAndHandleResponse(s)}_handleIncomingMessage(e){let s=e[t.FIELD.ID];if(!this._subscriptionCollections[s])this._client._onError("Received message for unknown subscription "+e);else for(var i=0;i<this._subscriptionCollections[s].length&&(this._subscriptionCollections[s][i]._processIncomingMessage(e),!!this._subscriptionCollections[s]);i++);}_invokeImmediatly(e){if(!!this._subscriptionCollections[e.id]){var s=null,i;for(i=0;i<this._subscriptionCollections[e.id].length;i++)this._subscriptionCollections[e.id][i]._data&&(s=this._subscriptionCollections[e.id][i]._data);s&&setTimeout(()=>{e.emit("update",s)},10)}}};var u=class extends h{constructor(e){super();this.constants=t,this.connectionStatus=t.CONNECTION_STATUS.DISCONNECTED,this.ping=null,this.options=this._extendOptions(e,{outgoingMessageBufferTime:0,logMessages:!1,logErrors:!0,adminDashboardBasePath:"/admin/",heartbeatInterval:5e3,reconnectInterval:1e3}),this.system=new A(this),this.realm=new O(this),this._subscription=new R(this),this._heartbeatInterval=setInterval(this._sendHeartbeatMessage.bind(this),this.options.heartbeatInterval),this._url=null,this._wsConnection=null,this._reconnectInterval=null,this._onConnectPromise=null,this._onAuthenticatePromise=null,this._onDisconnectPromise=null,this._pendingRequests={},this._pendingMessages=null,this._pendingHeartbeats={},this._typeHandler={[t.TYPE.SYSTEM]:this.system,[t.TYPE.SUBSCRIPTION]:this._subscription,[t.TYPE.REALM]:this.realm}}connect(e){return this._url=e,this._changeConnectionStatus(t.CONNECTION_STATUS.CONNECTING),this._wsConnection=new this.WsConstructor(e),this._wsConnection.onopen=this._onOpen.bind(this),this._wsConnection.onclose=this._onClose.bind(this),this._wsConnection.onerror=this._onError.bind(this),this._wsConnection.onmessage=this._onMessage.bind(this),this._onConnectPromise=T(),this._onConnectPromise}authenticate(e){return this.system._sendAuthMessage(e),this._onAuthenticatePromise=T(),this._onAuthenticatePromise}disconnect(){return this._changeConnectionStatus(t.CONNECTION_STATUS.DISCONNECTING),this._wsConnection.close(),this._onDisconnectPromise=T(),this._onDisconnectPromise}getId(e){return e+"-"+m()}getURL(){return this._wsConnection.url}_onOpen(){this._changeConnectionStatus(t.CONNECTION_STATUS.CONNECTED),clearInterval(this._reconnectInterval),this._onConnectPromise.resolve()}_onClose(){this.connectionStatus===t.CONNECTION_STATUS.DISCONNECTING?(clearInterval(this._heartbeatInterval),this._changeConnectionStatus(t.CONNECTION_STATUS.DISCONNECTED),this._onDisconnectPromise&&this._onDisconnectPromise.resolve()):(this._onError("Disconnected, attempting to reconnect"),this.connect(this._url).catch(()=>{clearInterval(this._reconnectInterval),this._reconnectInterval=setInterval(()=>{this._onError("Disconnected, attempting to reconnect"),this.connect(this._url)},this.options.reconnectInterval)}))}_onError(e){this.emit("error",e),this.options.logErrors&&console.warn(e.message||e)}_onMessage(e){try{let s=JSON.parse(e.data);Array.isArray(s)?s.forEach(this._handleIncomingMessage.bind(this)):this._onError(`Websocket Message was not expected form: ${JSON.stringify(s)}`)}catch(s){this._onError(`Failed to parse Websocket Message: ${s} - ${e.data}`)}}_sendMessage(e){this._pendingMessages===null?(this._pendingMessages=[e],this.connectionStatus===t.CONNECTION_STATUS.AUTHENTICATED?this._sendPendingMessageTimeout=setTimeout(this._sendPendingMessages.bind(this),this.options.outgoingMessageBufferTime):this.options.logErrors&&console.warn("hivekit connection not authenticated. Outgoing messages will be queued until authentication")):this._pendingMessages.push(e)}_sendPendingMessages(){if(!(!this._pendingMessages||this._pendingMessages.length===0)){if(this.options.logMessages)for(let e=0;e<this._pendingMessages.length;e++)console.log(">",this._pendingMessages[e]);this._wsConnection.send(JSON.stringify(this._pendingMessages)),this._pendingMessages=null}}_sendHeartbeatMessage(){if(this.connectionStatus!==t.CONNECTION_STATUS.AUTHENTICATED)return;let e=this.getId("heartbeat");this._pendingHeartbeats[e]=Date.now();let s=[{[t.FIELD.TYPE]:t.TYPE.SYSTEM,[t.FIELD.ACTION]:t.ACTION.HEARTBEAT,[t.FIELD.CORRELATION_ID]:e}];this._wsConnection.send(JSON.stringify(s))}_processHeartbeatResponse(e){this._pendingHeartbeats[e[t.FIELD.CORRELATION_ID]]&&(this.ping=Date.now()-this._pendingHeartbeats[e[t.FIELD.CORRELATION_ID]],this.emit("ping",this.ping)),delete this._pendingHeartbeats[e[t.FIELD.CORRELATION_ID]]}_handleIncomingMessage(e){this.options.logMessages&&console.log("<",e),e[t.FIELD.CORRELATION_ID]?this._pendingHeartbeats[e[t.FIELD.CORRELATION_ID]]?this._processHeartbeatResponse(e):this._pendingRequests[e[t.FIELD.CORRELATION_ID]]?(this._pendingRequests[e[t.FIELD.CORRELATION_ID]].responseCallbacks.forEach(s=>{s(e)}),delete this._pendingRequests[e[t.FIELD.CORRELATION_ID]]):this._onError("Received response for unknown request",e):e[t.FIELD.RESULT]===t.RESULT.ERROR?this._onError(e[t.FIELD.ERROR]||e[t.FIELD.DATA]):this._typeHandler[e[t.FIELD.TYPE]]?this._typeHandler[e[t.FIELD.TYPE]]._handleIncomingMessage(e):this._onError("Received message for unknown type "+this._typeHandler[e[t.FIELD.TYPE]])}_changeConnectionStatus(e){this.connectionStatus=e,this.emit("connectionStatusChanged",e),e===t.CONNECTION_STATUS.AUTHENTICATED&&this._sendPendingMessages()}_sendRequest(e,s){let i=this._getSignature(e);for(let o in this._pendingRequests)if(this._pendingRequests[o].signature===i){this._pendingRequests[o].responseCallbacks.push(s);return}let n=m();e[t.FIELD.CORRELATION_ID]=n,this._pendingRequests[n]={signature:i,responseCallbacks:[s]},this._sendMessage(e)}_sendRequestAndHandleResponse(e,s){let i=T();return this._sendRequest(e,n=>{n[t.FIELD.RESULT]===t.RESULT.ERROR?(this._onError(`${n[t.FIELD.ERROR]}`),i.reject(`${n[t.FIELD.ERROR]}`)):i.resolve(s?s(n):n)}),i}_getSignature(...e){let s=JSON.stringify(e),i=0,n=0;for(i;i<s.length;i++)n=(n<<5)-n+s.charCodeAt(i),n=n&n;return n}_extendOptions(e,s,i){if(!e)return s;i&&(e=this._compressFields(e,i));let n={};for(let o in s)typeof e[o]!="undefined"?n[o]=e[o]:n[o]=s[o];return n}_extendFields(e,s=c.FIELD){let i={};for(let n in e)s[n]?n===t.FIELD.LOCATION?i[s[n]]=this._extendFields(e[n],c.LOCATION):n===t.FIELD.PRESENCE_CONNECTION_STATUS?i[s[t.FIELD.PRESENCE_CONNECTION_STATUS]]=c.PRESENCE_CONNECTION_STATUS[e[n]]:n===t.FIELD.SUB_TYPE&&e[t.FIELD.SHAPE]?i[s[t.FIELD.SHAPE]]=c.SHAPE_TYPE[e[n]]:n===t.FIELD.SHAPE?i[s[t.FIELD.SHAPE_DATA]]=e[n]:n===t.FIELD.TYPE?i[s[t.FIELD.TYPE]]=c.TYPE[e[n]]:n===t.FIELD.FIELD?i[s[t.FIELD.FIELD]]=c.FIELD[e[n]]:i[s[n]]=e[n]:i[n]=e[n];return i}_extendFieldsMap(e){let s={};for(let i in e)s[i]=this._extendFields(e[i]);return s}_extendFieldsArray(e){let s=[];for(let i of e)s.push(this._extendFields(i));return s}_compressFields(e,s,i){let n=F(s),o={};for(let r in e)n[r]?o[n[r]]=e[r]:i?o[r]=e[r]:this._onError(`Unknown field ${r}`);return o}};u.prototype.WsConstructor=window.WebSocket;var ke=u;export{ke as default};
