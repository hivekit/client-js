var gt=Object.create;var Ce=Object.defineProperty;var Ut=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var wt=Object.getPrototypeOf,xt=Object.prototype.hasOwnProperty;var Mt=r=>Ce(r,"__esModule",{value:!0});var Vt=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Yt=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of yt(e))!xt.call(r,i)&&(t||i!=="default")&&Ce(r,i,{get:()=>e[i],enumerable:!(s=Ut(e,i))||s.enumerable});return r},Ht=(r,e)=>Yt(Mt(Ce(r!=null?gt(wt(r)):{},"default",!e&&r&&r.__esModule?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var nt=Vt((Ks,st)=>{st.exports=typeof self=="object"?self.FormData:window.FormData});var N=class{constructor(){this.listener={},this.listenerId=0}on(e,t,s,i){return this.listenerId++,this.listener[e]||(this.listener[e]=[]),this.listener[e].push({eventName:e,fn:t,context:s,order:i,id:this.listenerId}),this.listener[e].sort((a,o)=>a.order==o.order?0:a.order>o.order?1:-1),this.listenerId}off(e,t,s){if(!!this.listener[e]){for(var i=this.listener[e].length;i--;)this.listener[e][i].fn===t&&this.listener[e][i].context===s&&this.listener[e].splice(i,1);this.listener[e].length===0&&delete this.listener[e]}}removeListenerById(e,t){if(!this.listener[e])throw new Error("No listener registered for eventname "+e);var s=!1;if(this.listener[e]=this.listener[e].filter(i=>i.id===t?(s=!0,!1):!0),!s)throw new Error(`Failed to find listener with id ${t} for event ${e}`)}emit(e){if(!this.listener[e])return;let t=Array.prototype.slice.call(arguments,1);for(var s=null,i=0;this.listener[e]&&this.listener[e][i];){if(s=this.listener[e][i],this.listener[e][i].fn.apply(this.listener[e][i].context,t)===!1)return;this.listener[e]&&this.listener[e][i]===s&&i++}}hasListeners(e){return!!(this.listener[e]&&this.listener[e].length>0)}};var F={CONNECTION_STATUS:{CONNECTED:{VAL:"connected"},DISCONNECTED:{VAL:"disconnected"},CONNECTING:{VAL:"connecting"},DISCONNECTING:{VAL:"disconnecting"},AUTHENTICATED:{VAL:"authenticated"}},MODE:{HTTP:{VAL:"http"},WS:{VAL:"ws"}},TYPE:{REALM:{VAL:"rea",FULL:"realm"},OBJECT:{VAL:"obj",FULL:"object"},AREA:{VAL:"are",FULL:"area"},SUBSCRIPTION:{VAL:"sub",FULL:"subscription"},SYSTEM:{VAL:"sys",FULL:"system"},INSTRUCTION:{VAL:"ins",FULL:"instruction"},LOGEVENT:{VAL:"log",FULL:"logEvent"},HISTORY:{VAL:"his",FULL:"history"},TASK:{VAL:"tsk",FULL:"task"}},TASK_STATUS:{NOT_STARTED:{VAL:"$hkt_not_started"},IN_PROGRESS:{VAL:"$hkt_in_progress"},COMPLETED:{VAL:"$hkt_completed"},FAILED:{VAL:"$hkt_failed"},CANCELED:{VAL:"$hkt_canceled"},PAUSED:{VAL:"$hkt_paused"},BLOCKED:{VAL:"$hkt_blocked"}},ERROR:{CONNECTION_ERROR:{VAL:"connection_error"},MAX_RECONNECT_ATTEMPTS_EXCEEDED:{VAL:"max_reconnect_attempts_exceeded"},MESSAGE_PARSE_ERROR:{VAL:"message_parse_error"},UNKNOWN_REQUEST:{VAL:"unknown_request"},UNKNOWN_TYPE:{VAL:"unknown_type"},SERVER_ERROR:{VAL:"server_error"},UNKNOWN_FIELD:{VAL:"unknown_field"},UNKNOWN_ACTION:{VAL:"unknown_action"},UNKNOWN_SUBSCRIPTION:{VAL:"unknown_subscription"},DISCONNECTED_RETRYING:{VAL:"disconnected_retrying"}},UPDATE_TYPE:{FULL:{VAL:"ful"},DELTA:{VAL:"dta"}},FIELD:{TYPE:{VAL:"typ",FULL:"type"},SCOPE_TYPE:{VAL:"sty",FULL:"scopeType"},SUB_TYPE:{VAL:"sty",FULL:"scopeType"},SCOPE_ID:{VAL:"sid",FULL:"scopeId"},EXECUTE_IMMEDIATELY:{VAL:"exe",FULL:"executeImmediately"},ACTION:{VAL:"act",FULL:"action"},RESULT:{VAL:"res",FULL:"result"},CORRELATION_ID:{VAL:"cid",FULL:"correlationId"},ID:{VAL:"id",FULL:"id"},REALM:{VAL:"rea",FULL:"realm"},DATA:{VAL:"dat",FULL:"data"},LOCATION:{VAL:"loc",FULL:"location"},ERROR:{VAL:"err",FULL:"error"},LABEL:{VAL:"lab",FULL:"label"},ATTRIBUTE:{VAL:"atr",FULL:["attribute","where"]},UPDATE_TYPE:{VAL:"uty"},INSTRUCTION_STRING:{VAL:"ins",FULL:"instructionString"},PRESENCE_CONNECTION_STATUS:{VAL:"cst",FULL:"connectionStatus"},SHAPE:{VAL:"sha",FULL:"shape"},SHAPE_DATA:{VAL:"shapeData",FULL:"shapeData"},FIELD:{VAL:"fie",FULL:"field"},VALUE:{VAL:"val",FULL:"value"},SUBSCRIPTION_TARGET:{VAL:"sta",FULL:"start"},START:{VAL:"sta",FULL:"start"},END:{VAL:"end",FULL:"end"},LEVEL:{VAL:"lvl",FULL:"level"},EVENT_NAME:{VAL:"eve"},ID_PATTERN:{VAL:"idp"},ERROR_CODE:{VAL:"erc"},INTERVAL:{VAL:"int",FULL:"interval"},TIME:{VAL:"tim",FULL:"time"},SCOPE_TYPE_TARGET:{VAL:"tar"},RADIUS:{VAL:"r"},STATUS:{VAL:"sts",FULL:"status"},STEPS:{VAL:"stp",FULL:"steps"},DESCRIPTION:{VAL:"dsc",FULL:"description"},TARGET_ID:{VAL:"tid",FULL:"targetId"},TASK_IDS:{VAL:"tds",FULL:"taskIds"}},ACTION:{CREATE:{VAL:"cre",FULL:"create"},READ:{VAL:"rea",FULL:"read"},LIST:{VAL:"lis",FULL:"list"},UPDATE:{VAL:"upd",FULL:"update"},DELETE:{VAL:"del",FULL:"delete"},AUTHENTICATE:{VAL:"aut",FULL:"authenticate"},SET:{VAL:"set",FULL:"set"},SEARCH:{VAL:"sea"},HEARTBEAT:{VAL:"hbt"},SUBSCRIBE:{VAL:"sub"},UNSUBSCRIBE:{VAL:"uns"},PUBLISH:{VAL:"pub"},GET_STATS:{VAL:"sta"}},RESULT:{SUCCESS:{VAL:"suc",FULL:"success"},WARNING:{VAL:"war",FULL:"warning"},ERROR:{VAL:"err",FULL:"error"}},SUBSCRIPTION:{REALM:{VAL:"all-realms"}},LOCATION:{GEOGRAPHIC_COORDINATE_SYSTEM:{VAL:"gcs",FULL:"coordinateSystem"},LONGITUDE:{VAL:"lon",FULL:"longitude"},LATITUDE:{VAL:"lat",FULL:"latitude"},ACCURACY:{VAL:"acc",FULL:"accuracy"},SPEED:{VAL:"spe",FULL:"speed"},HEADING:{VAL:"hea",FULL:"heading"},ALTITUDE:{VAL:"alt",FULL:"altitude"},ALTITUDE_ACCURACY:{VAL:"alc",FULL:"altitudeAccuracy"},TIME:{VAL:"tim",FULL:"time"}},SHAPE_TYPE:{RECTANGLE:{VAL:"rec",FULL:"rectangle"},CIRCLE:{VAL:"cir",FULL:"circle"},POLYGON:{VAL:"pol",FULL:"polygon"}},PRESENCE_CONNECTION_STATUS:{CONNECTED:{VAL:"con",FULL:"connected"},DISCONNECTED:{VAL:"dis",FULL:"disconnected"}}},n=function(){let r={};for(let e in F){r[e]={};for(let t in F[e])r[e][t]=F[e][t].VAL}return r}(),T=function(){let e={};for(let t in F){let s={};for(let i in F[t])F[t][i].FULL&&(s[F[t][i].VAL]=F[t][i].FULL);Object.keys(s).length>0&&(e[t]=s)}return e}();function f(r,e,t,s,i,a){let o={[n.FIELD.TYPE]:r,[n.FIELD.ACTION]:e};return t&&(o[n.FIELD.ID]=t),s&&(o[n.FIELD.REALM]=s),i&&(o[n.FIELD.DATA]=i),a&&(o[n.FIELD.LOCATION]=a),o}var re=class{constructor(e){this._client=e,this._systemUpdateSubscription=null}getHttpRoot(){if(this._client.options.httpRoot)return this._client.options.httpRoot;let e=this._client._url||(typeof document=="undefined"?null:document.location.href);if(!e)return null;var t;try{t=new URL(e)}catch{return null}return(t.protocol==="wss:"||t.protocol==="https:"?"https":"http")+"://"+t.host}authenticateAdmin(e){return new Promise(async(t,s)=>{let i=this.getHttpRoot();if(!i){s(new Error("no http url found"));return}let a=i+this._client.options.adminDashboardBasePath+"api/authenticate-admin";var o;try{o=await fetch(a,{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:"admin",password:e})})}catch(u){s(u.message);return}if(o.status===200)t();else{let u=await o.json();s(new Error(u[0][n.FIELD.ERROR]))}})}getServerStats(){let e=f(n.TYPE.SYSTEM,n.ACTION.GET_STATS);return this._client._sendRequestAndHandleResponse(e,t=>t[n.FIELD.DATA])}_sendAuthMessage(e){this._client._connection.readyState===this._client._connection.constructor.OPEN?this._client._connection.send("Bearer "+e):this._client._connection.addEventListener("open",()=>{this._client._connection.send("Bearer "+e)})}_handleIncomingMessage(e){switch(e[n.FIELD.ACTION]){case n.ACTION.AUTHENTICATE:e[n.FIELD.RESULT]===n.RESULT.SUCCESS&&(e[n.FIELD.DATA]&&(this._client.serverVersion=e[n.FIELD.DATA].version,this._client.serverBuildDate=e[n.FIELD.DATA].buildDate),this._client._changeConnectionStatus(n.CONNECTION_STATUS.AUTHENTICATED),this._client._onAuthenticatePromise&&this._client._onAuthenticatePromise.resolve()),e[n.FIELD.RESULT]===n.RESULT.ERROR&&this._client._onAuthenticatePromise&&this._client._onAuthenticatePromise.reject(e[n.FIELD.ERROR]);break;default:this._client._onError(`Unknown action for type ${n.TYPE.SYSTEM}: ${e[n.FIELD.ACTION]}`,n.ERROR.UNKNOWN_ACTION)}}};function w(){var r,e;let t=new Promise((s,i)=>{r=s,e=i});return t.resolve=r,t.reject=e,t}function Ge(r){let e={};for(var t in r)r[t]instanceof Array?r[t].forEach(s=>{e[s]=t}):e[r[t]]=t;return e}function O(r,e){for(var t in e)r[t]=e[t];return r}function M(r){return JSON.parse(JSON.stringify(r))}var We={x1x2y1y2:n.SHAPE_TYPE.RECTANGLE,cxcyr:n.SHAPE_TYPE.CIRCLE,points:n.SHAPE_TYPE.POLYGON};function V(r){var e=Object.keys(r).sort().join("");return e==="eastnorthsouthwest"&&(r={x1:r.west,y1:r.south,x2:r.east,y2:r.north},e="x1x2y1y2"),We[e]?{type:We[e],data:r,err:null}:{err:"unknown shape data"}}function Ne(r){return r instanceof Date&&r.toString()!="Invalid Date"}var Fe={};for(Pe in T.LOCATION)Fe[T.LOCATION[Pe]]=Pe;var Pe;function se(r){let e={};for(var t in r)if(t.length!==0){if(typeof r[t]!="string"){e[Fe[t]]=r[t];continue}if(r[t].length>0)if(t===T.LOCATION[n.LOCATION.TIME])try{e[t]=new Date(r[t]).toISOString()}catch(s){throw new Error(`Can't convert ${r[t]} into a valid date:${s}`)}else e[Fe[t]]=parseFloat(r[t])}return e}var ne=class{constructor(e,t){this._client=e,this._realm=t}subscribe(e){if(e=e||{},e.shape){let t=V(e.shape);if(t.err)return Promise.reject(t.err);e.scopeType=t.type,e.shape=t.data}return e.target&&(e[n.FIELD.SUBSCRIPTION_TARGET]=e.target,e[n.FIELD.SCOPE_TYPE]=n.FIELD.SCOPE_TYPE_TARGET,delete e.target),this._client._subscription._getSubscription(this._client.getId("object-subscription"),this._realm.id,O({[n.FIELD.TYPE]:n.TYPE.OBJECT,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD,!0)))}get(e){if(!e)throw new Error("no id provided for object.get");let t=f(n.TYPE.OBJECT,n.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t,s=>{let i=this._client._extendFields(s[n.FIELD.DATA]);return i.data=i.data||{},i.taskIds=i.taskIds||[],i})}create(e,t){return this._setObjectState(e,t.label,t.location,t.data,t.taskIds,n.ACTION.CREATE)}update(e,t){return this._setObjectState(e,t.label,t.location,t.data,t.taskIds,n.ACTION.UPDATE)}set(e,t){return this._setObjectState(e,t.label,t.location,t.data,t.taskIds,n.ACTION.SET)}list(e){let t=f(n.TYPE.OBJECT,n.ACTION.LIST,null,this._realm.id);return e&&Object.keys(e).length>0&&(t[n.FIELD.DATA]=this._client._compressFields(e,T.FIELD)),this._client._sendRequestAndHandleResponse(t,s=>this._client._extendFieldsMap(s[n.FIELD.DATA]))}delete(e){let t=f(n.TYPE.OBJECT,n.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t)}_setObjectState(e,t,s,i,a,o){let u=f(n.TYPE.OBJECT,o,e,this._realm.id);if(t&&(u[n.FIELD.LABEL]=t),s&&Object.keys(s).length>0&&(u[n.FIELD.LOCATION]=se(s)),i&&Object.keys(i).length>0&&(u[n.FIELD.DATA]=i),Array.isArray(a)&&(u[n.FIELD.TASK_IDS]=a),o===n.ACTION.SET&&this._client.mode!==n.MODE.HTTP)this._client._sendMessage(u);else return this._client._sendRequestAndHandleResponse(u)}};var ie=class{constructor(e,t){this._client=e,this._realm=t}subscribe(e){return this._client._subscription._getSubscription(this._client.getId("area-subscription"),this._realm.id,O({[n.FIELD.TYPE]:n.TYPE.AREA,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD)))}get(e){let t=f(n.TYPE.AREA,n.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t,s=>this._client._extendFields(s[n.FIELD.DATA]))}create(e,t){return this._setAreaState(e,t.label,t.shapeData||t.shape,t.data,n.ACTION.CREATE)}update(e,t){return this._setAreaState(e,t.label,t.shapeData||t.shape,t.data,n.ACTION.UPDATE)}list(){let e=f(n.TYPE.AREA,n.ACTION.LIST,null,this._realm.id);return this._client._sendRequestAndHandleResponse(e,t=>{let s=this._client._extendFieldsMap(t[n.FIELD.DATA]);for(var i in s)s[i].shape=T.SHAPE_TYPE[s[i].scopeType],delete s[i].scopeType;return s})}delete(e){let t=f(n.TYPE.AREA,n.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t)}_setAreaState(e,t,s,i,a){let o=f(n.TYPE.AREA,a,e,this._realm.id),u=V(s);return u.err?Promise.reject(u.err):(o[n.FIELD.SUB_TYPE]=u.type,o[n.FIELD.SHAPE]=u.data,t&&(o[n.FIELD.LABEL]=t),i&&(o[n.FIELD.DATA]=i),this._client._sendRequestAndHandleResponse(o))}};var oe=class{constructor(e,t){this._client=e,this._realm=t}subscribe(e){return this._client._subscription._getSubscription(this._client.getId("instruction-subscription"),this._realm.id,O({[n.FIELD.TYPE]:n.TYPE.INSTRUCTION,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD)))}subscribeToLogs(e){return this._client._subscription._getSubscription(this._client.getId("instruction-log-subscription"),this._realm.id,O({[n.FIELD.TYPE]:n.TYPE.LOGEVENT,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD)))}get(e){let t=f(n.TYPE.INSTRUCTION,n.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t,s=>this._client._extendFields(s[n.FIELD.DATA]))}create(e,t){return this._setInstructionState(e,t.label,t.instructionString,t.data,n.ACTION.CREATE)}update(e,t){return this._setInstructionState(e,t.label,t.instructionString,t.data,n.ACTION.UPDATE)}list(){let e=f(n.TYPE.INSTRUCTION,n.ACTION.LIST,null,this._realm.id);return this._client._sendRequestAndHandleResponse(e,t=>this._client._extendFieldsMap(t[n.FIELD.DATA]))}delete(e){let t=f(n.TYPE.INSTRUCTION,n.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t)}_setInstructionState(e,t,s,i,a){let o=f(n.TYPE.INSTRUCTION,a,e,this._realm.id);return o[n.FIELD.INSTRUCTION_STRING]=s,t&&(o[n.FIELD.LABEL]=t),i&&(o[n.FIELD.DATA]=i),this._client._sendRequestAndHandleResponse(o)}};var ae=class{constructor(e,t){this._client=e,this._realm=t,this._subscriptionCallbacks=[]}subscribe(e,t,s){let i="*";arguments.length===2?s=t:i=t;let a=`${e}:${i}`,o=this._subscriptionCallbacks[a];if(this._subscriptionCallbacks[a]=this._subscriptionCallbacks[a]||[],this._subscriptionCallbacks[a].push(s),!o){let u=this._getPubSubMessage(n.ACTION.SUBSCRIBE,e,i);return this._client._repeatOnReconnect("pubsub",this._realm.id,e+i,u),this._client._sendRequestAndHandleResponse(u)}return Promise.resolve({})}unsubscribe(e,t,s){let i="*",a=null;typeof t=="function"?a=t:t&&(i=t);let o=`${e}:${i}`;if(this._subscriptionCallbacks[o]){if(a){let h=this._subscriptionCallbacks[o],l=h.indexOf(a);l>-1&&h.splice(l,1)}else this._subscriptionCallbacks[o].length=0;if(this._subscriptionCallbacks[o].length===0)return delete this._subscriptionCallbacks[o],this._client._removeFromRepeatOnReconnect("pubsub",this._realm.id,e+i),this._client._sendRequestAndHandleResponse(this._getPubSubMessage(n.ACTION.UNSUBSCRIBE,e,i))}return Promise.reject({message:"no subscription with that id pattern",code:400})}publish(e,t,s){var i;arguments.length===2?(i="*",s=t):i=t;let a=this._getPubSubMessage(n.ACTION.PUBLISH,e,i);return a[n.FIELD.DATA][n.FIELD.DATA]=s,this._client._sendRequestAndHandleResponse(a)}_emitSubscriptionEvent(e,t,s){let i=`${e}:${s}`,a=this._subscriptionCallbacks[i];if(a){["connectionStatusChanged"].includes(e)&&(t=this._client._extendFields(t));for(let o=0;o<a.length;o++)a[o](t)}}_getPubSubMessage(e,t,s){let i=f(n.TYPE.REALM,e,this._realm.id);return i[n.FIELD.DATA]={[n.FIELD.EVENT_NAME]:t,[n.FIELD.ID_PATTERN]:s||"*"},i}};var ce=class{constructor(e,t){this._client=e,this._realm=t}get(e,t){let s=f(n.TYPE.HISTORY,n.ACTION.READ,e,this._realm.id);if(!Ne(t.startTime))throw new Error("startTime is not a valid Date object");if(!Ne(t.endTime))throw new Error("endTime is not a valid Date object");return s[n.FIELD.DATA]={[n.FIELD.START]:t.startTime.toISOString(),[n.FIELD.END]:t.endTime.toISOString()},this._client._sendRequestAndHandleResponse(s,i=>i[n.FIELD.DATA].map(a=>this._client._extendFields(a)))}};var le=class{constructor(e,t){this._client=e,this._realm=t}subscribe(e){return this._client._subscription._getSubscription(this._client.getId("task-subscription"),this._realm.id,O({[n.FIELD.TYPE]:n.TYPE.TASK,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD)))}get(e){let t=f(n.TYPE.TASK,n.ACTION.READ,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t,s=>{let i=this._client._extendFields(s[n.FIELD.DATA]);return i.steps&&(i.steps=i.steps.map(a=>this._client._extendFields(a))),i})}create(e,t){let s=t.location&&Object.keys(t.location).length>0;if(s&&t.targetId)throw new Error("Cannot set both location and targetId");if(!s&&!t.targetId)throw new Error("Task needs either a targetId or location");return this._setTaskState(e,t,n.ACTION.CREATE)}update(e,t){return this._setTaskState(e,t,n.ACTION.UPDATE)}list(){let e=f(n.TYPE.TASK,n.ACTION.LIST,null,this._realm.id);return this._client._sendRequestAndHandleResponse(e,t=>this._client._extendFieldsMap(t[n.FIELD.DATA]))}delete(e){let t=f(n.TYPE.TASK,n.ACTION.DELETE,e,this._realm.id);return this._client._sendRequestAndHandleResponse(t)}_setTaskState(e,t,s){let i=f(n.TYPE.TASK,s,e,this._realm.id);if(t.label&&(i[n.FIELD.LABEL]=t.label),t.data&&(i[n.FIELD.DATA]=t.data),t.status){if(!Object.values(n.TASK_STATUS).includes(t.status))throw new Error(`Invalid task status: ${t.status}`);i[n.FIELD.STATUS]=t.status}return t.location&&(i[n.FIELD.LOCATION]=se(t.location)),t.steps&&(i[n.FIELD.STEPS]=t.steps.map(a=>this._client._compressFields(a,T.FIELD))),t.targetId&&(i[n.FIELD.TARGET_ID]=t.targetId),t.description&&(i[n.FIELD.DESCRIPTION]=t.description),this._client._sendRequestAndHandleResponse(i)}};var ue=class extends N{constructor(e,t,s,i){super();this._client=i,this._data=s,this._subscriptionCallbacks={},this.id=e,this.label=t,this.object=new ne(i,this),this.area=new ie(i,this),this.instruction=new oe(i,this),this.pubsub=new ae(i,this),this.history=new ce(i,this),this.task=new le(i,this),i.mode!==n.MODE.HTTP&&i._subscription._getSubscription(i.getId(`realm-data-${e}`),e,{[n.FIELD.TYPE]:n.TYPE.REALM,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM}).then(a=>{this._dataSub=a,a.on("update",({data:o,label:u})=>{this._data=o,this.label=u,this.emit("update")})})}getData(e){if(this._client.mode===n.MODE.HTTP){let t=f(n.TYPE.REALM,n.ACTION.READ,this.id);return this._client._sendRequestAndHandleResponse(t,s=>{let i=s[n.FIELD.DATA][n.FIELD.DATA]||{};return e?i[e]:i})}return e?typeof this._data[e]=="object"?M(this._data[e]):this._data[e]:M(this._data)}setData(e,t){let s=f(n.TYPE.REALM,n.ACTION.UPDATE,this.id);return this._data[e]=t,s[n.FIELD.DATA]=M(this._data),t===null&&delete this._data[e],this.emit("update"),this._client._sendRequestAndHandleResponse(s)}setLabel(e){let t=f(n.TYPE.REALM,n.ACTION.UPDATE,this.id);return this.label=e,t[n.FIELD.LABEL]=e,this.emit("update"),this._client._sendRequestAndHandleResponse(t)}search(e,t){let s=this._client._compressFields(t,T.FIELD,!0);s.val=e;let i=f(n.TYPE.REALM,n.ACTION.SEARCH,null,this.id,s);return this._client._sendRequestAndHandleResponse(i,a=>a[n.FIELD.DATA]?a[n.FIELD.DATA].map(o=>{let u=this._client._extendFields(o);return u.dataProperty=u.scopeType,delete u.scopeType,u}):[])}};var de=class{constructor(e){this._client=e,this._realms={},this._useCache=e.mode!==n.MODE.HTTP}subscribe(){return this._client._subscription._getSubscription(this._client.getId("realm-subscription-"),n.TYPE.SYSTEM,{[n.FIELD.TYPE]:n.TYPE.SYSTEM,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM})}get(e){if(this._useCache&&this._realms[e])return Promise.resolve(this._realms[e]);let t=f(n.TYPE.REALM,n.ACTION.READ,e);return this._client._sendRequestAndHandleResponse(t,s=>{let i=new ue(e,s[n.FIELD.DATA][n.FIELD.LABEL],s[n.FIELD.DATA][n.FIELD.DATA]||{},this._client);return this._useCache&&(this._realms[e]=i),i})}create(e,t,s){let i=f(n.TYPE.REALM,n.ACTION.CREATE,e);return t&&(i[n.FIELD.LABEL]=t),s&&Object.keys(s).length>0&&(i[n.FIELD.DATA]=s),this._client._sendRequestAndHandleResponse(i)}list(){let e=f(n.TYPE.REALM,n.ACTION.LIST);return this._client._sendRequestAndHandleResponse(e,t=>this._client._extendFieldsMap(t.dat))}delete(e){let t=f(n.TYPE.REALM,n.ACTION.DELETE,e);return this._client._sendRequestAndHandleResponse(t)}_handleIncomingMessage(e){e[n.FIELD.ACTION]===n.ACTION.PUBLISH&&this._realms[e[n.FIELD.REALM]]&&this._realms[e[n.FIELD.REALM]].pubsub._emitSubscriptionEvent(e[n.FIELD.DATA][n.FIELD.EVENT_NAME],e[n.FIELD.DATA][n.FIELD.DATA],e[n.FIELD.SCOPE_ID])}};var be=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r));for(;r--;){let s=t[r]&63;s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s<63?e+="_":e+="-"}return e};var j=class extends N{constructor(e,t,s){super();this.id=t,this.realmId=s,this._client=e,this._data=null}cancel(){return this.listener={},this._client._subscription._removeSubscription(this)}update(e){if(e&&e.shape){let s=V(e.shape);if(s.err)return Promise.reject(s.err);e.scopeType=s.type,e.shape=s.data}let t=f(n.TYPE.SUBSCRIPTION,n.ACTION.UPDATE,this.id,this.realmId,O({[n.FIELD.TYPE]:n.TYPE.OBJECT,[n.FIELD.SCOPE_TYPE]:n.TYPE.REALM},this._client._compressFields(e,T.FIELD)));return this._client._sendRequestAndHandleResponse(t)}_processIncomingMessage(e){if(this._data===null&&(this._data={}),e[n.TYPE.OBJECT]||e[n.TYPE.TASK]){let i=e[n.TYPE.OBJECT]||e[n.TYPE.TASK],a={added:this._client._extendFieldsMap(i[n.ACTION.CREATE]),updated:this._client._extendFieldsMap(i[n.ACTION.UPDATE]),removed:i[n.ACTION.DELETE]};e[n.FIELD.UPDATE_TYPE]===n.UPDATE_TYPE.FULL&&(this._data={});for(let o in a.added)this._data[o]=a.added[o];for(let o in a.updated)this._data[o]=a.updated[o];for(let o in a.removed)delete this._data[o];this.emit("update",this._data,a,e[n.FIELD.UPDATE_TYPE]===n.UPDATE_TYPE.FULL?"full":"delta");return}var t={};switch(e[n.TYPE.AREA]?t=this._client._extendFieldsMap(e[n.TYPE.AREA]):e[n.TYPE.INSTRUCTION]?t=this._client._extendFieldsMap(e[n.TYPE.INSTRUCTION]):e[n.TYPE.LOGEVENT]?t=this._client._extendFieldsArray(e[n.TYPE.LOGEVENT]):e[n.TYPE.REALM]?t=this._client._extendFields(e[n.TYPE.REALM]):e[n.FIELD.DATA]&&e[n.FIELD.DATA][n.FIELD.TYPE]===n.TYPE.REALM&&(t={realmId:e[n.FIELD.DATA][n.FIELD.ID],action:T.ACTION[e[n.FIELD.DATA][n.FIELD.ACTION]]}),e[n.FIELD.UPDATE_TYPE]){case n.UPDATE_TYPE.FULL:this._data=t;break;case n.UPDATE_TYPE.DELTA:for(var s in t)this._data[s]=t[s];break;default:this._client._onError("Received subscription message with unknown update type "+e[n.FIELD.UPDATE_TYPE],n.ERROR.UNKNOWN_TYPE);return}this.emit("update",this._data)}};var he=class{constructor(e){this._client=e,this._subscriptionCollections={},this._pendingSubscriptionPromises={}}_getSubscription(e,t,s){let i=w(),a=this._client._getSignature(t,s);var o,u=this._subscriptionCollections[e];if(!u)for(var h in this._subscriptionCollections)this._subscriptionCollections[h].signature===a&&(e=h,u=this._subscriptionCollections[e]);if(u)return o=new j(this._client,e,t),u.push(o),i.resolve(o),s[n.FIELD.EXECUTE_IMMEDIATELY]&&this._invokeImmediatly(o),i;if(e||(e=this.getId(this.constants.TYPE.SUBSCRIPTION)),o=new j(this._client,e,t),this._subscriptionCollections[e]=[o],this._subscriptionCollections[e].signature=a,this._pendingSubscriptionPromises[a])return this._pendingSubscriptionPromises[a].push({resultPromise:i,subscription:o}),i;this._pendingSubscriptionPromises[a]=[{resultPromise:i,subscription:o}];let l=f(n.TYPE.SUBSCRIPTION,n.ACTION.CREATE,e,t,s);return this._client._repeatOnReconnect(n.TYPE.SUBSCRIPTION,t,e,l),this._client._sendRequest(l,E=>{E[n.FIELD.RESULT]===n.RESULT.SUCCESS?this._pendingSubscriptionPromises[a].forEach(_=>{_.resultPromise.resolve(_.subscription)}):this._pendingSubscriptionPromises[a].forEach(_=>{_.resultPromise.reject(E[n.FIELD.ERROR])}),delete this._pendingSubscriptionPromises[a]}),i}_removeSubscription(e){if(!this._subscriptionCollections[e.id])throw new Error("Can`t remove unknown subscription "+e.id);if(!this._subscriptionCollections[e.id].includes(e))throw new Error("Subscription not found for id "+e.id);if(this._subscriptionCollections[e.id]=this._subscriptionCollections[e.id].filter(s=>e!==s),this._subscriptionCollections[e.id].length>0)return new Promise(s=>{s()});let t=f(n.TYPE.SUBSCRIPTION,n.ACTION.DELETE,e.id,e.realmId);return this._client._removeFromRepeatOnReconnect(n.TYPE.SUBSCRIPTION,e.realmId,e.id),delete this._subscriptionCollections[e.id],this._client._sendRequestAndHandleResponse(t)}_handleIncomingMessage(e){let t=e[n.FIELD.ID];if(!this._subscriptionCollections[t])this._client._onError("Received message for unknown subscription "+e,n.ERROR.UNKNOWN_SUBSCRIPTION);else for(var s=0;s<this._subscriptionCollections[t].length&&(this._subscriptionCollections[t][s]._processIncomingMessage(e),!!this._subscriptionCollections[t]);s++);}_invokeImmediatly(e){if(!!this._subscriptionCollections[e.id]){var t=null,s;for(s=0;s<this._subscriptionCollections[e.id].length;s++)if(this._subscriptionCollections[e.id][s]._data){t=this._subscriptionCollections[e.id][s]._data;break}t&&setTimeout(()=>{e._data=M(t),e.emit("update",e._data)},1)}}};function v(r,e){return function(){return r.apply(e,arguments)}}var{toString:Ke}=Object.prototype,{getPrototypeOf:ge}=Object,Ue=(r=>e=>{let t=Ke.call(e);return r[t]||(r[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),C=r=>(r=r.toLowerCase(),e=>Ue(e)===r),fe=r=>e=>typeof e===r,{isArray:q}=Array,ye=fe("undefined");function Bt(r){return r!==null&&!ye(r)&&r.constructor!==null&&!ye(r.constructor)&&Y(r.constructor.isBuffer)&&r.constructor.isBuffer(r)}var ze=C("ArrayBuffer");function kt(r){let e;return typeof ArrayBuffer!="undefined"&&ArrayBuffer.isView?e=ArrayBuffer.isView(r):e=r&&r.buffer&&ze(r.buffer),e}var jt=fe("string"),Y=fe("function"),Xe=fe("number"),Qe=r=>r!==null&&typeof r=="object",vt=r=>r===!0||r===!1,Ee=r=>{if(Ue(r)!=="object")return!1;let e=ge(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},qt=C("Date"),Jt=C("File"),$t=C("Blob"),Gt=C("FileList"),Wt=r=>Qe(r)&&Y(r.pipe),Kt=r=>{let e="[object FormData]";return r&&(typeof FormData=="function"&&r instanceof FormData||Ke.call(r)===e||Y(r.toString)&&r.toString()===e)},zt=C("URLSearchParams"),Xt=r=>r.trim?r.trim():r.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function pe(r,e,{allOwnKeys:t=!1}={}){if(r===null||typeof r=="undefined")return;let s,i;if(typeof r!="object"&&(r=[r]),q(r))for(s=0,i=r.length;s<i;s++)e.call(null,r[s],s,r);else{let a=t?Object.getOwnPropertyNames(r):Object.keys(r),o=a.length,u;for(s=0;s<o;s++)u=a[s],e.call(null,r[u],u,r)}}function we(){let r={},e=(t,s)=>{Ee(r[s])&&Ee(t)?r[s]=we(r[s],t):Ee(t)?r[s]=we({},t):q(t)?r[s]=t.slice():r[s]=t};for(let t=0,s=arguments.length;t<s;t++)arguments[t]&&pe(arguments[t],e);return r}var Qt=(r,e,t,{allOwnKeys:s}={})=>(pe(e,(i,a)=>{t&&Y(i)?r[a]=v(i,t):r[a]=i},{allOwnKeys:s}),r),Zt=r=>(r.charCodeAt(0)===65279&&(r=r.slice(1)),r),er=(r,e,t,s)=>{r.prototype=Object.create(e.prototype,s),r.prototype.constructor=r,Object.defineProperty(r,"super",{value:e.prototype}),t&&Object.assign(r.prototype,t)},tr=(r,e,t,s)=>{let i,a,o,u={};if(e=e||{},r==null)return e;do{for(i=Object.getOwnPropertyNames(r),a=i.length;a-- >0;)o=i[a],(!s||s(o,r,e))&&!u[o]&&(e[o]=r[o],u[o]=!0);r=t!==!1&&ge(r)}while(r&&(!t||t(r,e))&&r!==Object.prototype);return e},rr=(r,e,t)=>{r=String(r),(t===void 0||t>r.length)&&(t=r.length),t-=e.length;let s=r.indexOf(e,t);return s!==-1&&s===t},sr=r=>{if(!r)return null;if(q(r))return r;let e=r.length;if(!Xe(e))return null;let t=new Array(e);for(;e-- >0;)t[e]=r[e];return t},nr=(r=>e=>r&&e instanceof r)(typeof Uint8Array!="undefined"&&ge(Uint8Array)),ir=(r,e)=>{let s=(r&&r[Symbol.iterator]).call(r),i;for(;(i=s.next())&&!i.done;){let a=i.value;e.call(r,a[0],a[1])}},or=(r,e)=>{let t,s=[];for(;(t=r.exec(e))!==null;)s.push(t);return s},ar=C("HTMLFormElement"),cr=r=>r.toLowerCase().replace(/[_-\s]([a-z\d])(\w*)/g,function(t,s,i){return s.toUpperCase()+i}),Ze=(({hasOwnProperty:r})=>(e,t)=>r.call(e,t))(Object.prototype),lr=C("RegExp"),et=(r,e)=>{let t=Object.getOwnPropertyDescriptors(r),s={};pe(t,(i,a)=>{e(i,a,r)!==!1&&(s[a]=i)}),Object.defineProperties(r,s)},ur=r=>{et(r,(e,t)=>{let s=r[t];if(!!Y(s)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not read-only method '"+t+"'")})}})},dr=(r,e)=>{let t={},s=i=>{i.forEach(a=>{t[a]=!0})};return q(r)?s(r):s(String(r).split(e)),t},hr=()=>{},fr=(r,e)=>(r=+r,Number.isFinite(r)?r:e),c={isArray:q,isArrayBuffer:ze,isBuffer:Bt,isFormData:Kt,isArrayBufferView:kt,isString:jt,isNumber:Xe,isBoolean:vt,isObject:Qe,isPlainObject:Ee,isUndefined:ye,isDate:qt,isFile:Jt,isBlob:$t,isRegExp:lr,isFunction:Y,isStream:Wt,isURLSearchParams:zt,isTypedArray:nr,isFileList:Gt,forEach:pe,merge:we,extend:Qt,trim:Xt,stripBOM:Zt,inherits:er,toFlatObject:tr,kindOf:Ue,kindOfTest:C,endsWith:rr,toArray:sr,forEachEntry:ir,matchAll:or,isHTMLForm:ar,hasOwnProperty:Ze,hasOwnProp:Ze,reduceDescriptors:et,freezeMethods:ur,toObjectSet:dr,toCamelCase:cr,noop:hr,toFiniteNumber:fr};function H(r,e,t,s,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=r,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),s&&(this.request=s),i&&(this.response=i)}c.inherits(H,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var tt=H.prototype,rt={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(r=>{rt[r]={value:r}});Object.defineProperties(H,rt);Object.defineProperty(tt,"isAxiosError",{value:!0});H.from=(r,e,t,s,i,a)=>{let o=Object.create(tt);return c.toFlatObject(r,o,function(h){return h!==Error.prototype},u=>u!=="isAxiosError"),H.call(o,r.message,e,t,s,i),o.cause=r,o.name=r.name,a&&Object.assign(o,a),o};var m=H;var it=Ht(nt(),1),ot=it.default;function xe(r){return c.isPlainObject(r)||c.isArray(r)}function at(r){return c.endsWith(r,"[]")?r.slice(0,-2):r}function ct(r,e,t){return r?r.concat(e).map(function(i,a){return i=at(i),!t&&a?"["+i+"]":i}).join(t?".":""):e}function Er(r){return c.isArray(r)&&!r.some(xe)}var pr=c.toFlatObject(c,{},null,function(e){return/^is[A-Z]/.test(e)});function mr(r){return r&&c.isFunction(r.append)&&r[Symbol.toStringTag]==="FormData"&&r[Symbol.iterator]}function Tr(r,e,t){if(!c.isObject(r))throw new TypeError("target must be an object");e=e||new(ot||FormData),t=c.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(A,y){return!c.isUndefined(y[A])});let s=t.metaTokens,i=t.visitor||E,a=t.dots,o=t.indexes,h=(t.Blob||typeof Blob!="undefined"&&Blob)&&mr(e);if(!c.isFunction(i))throw new TypeError("visitor must be a function");function l(d){if(d===null)return"";if(c.isDate(d))return d.toISOString();if(!h&&c.isBlob(d))throw new m("Blob is not supported. Use a Buffer instead.");return c.isArrayBuffer(d)||c.isTypedArray(d)?h&&typeof Blob=="function"?new Blob([d]):Buffer.from(d):d}function E(d,A,y){let S=d;if(d&&!y&&typeof d=="object"){if(c.endsWith(A,"{}"))A=s?A:A.slice(0,-2),d=JSON.stringify(d);else if(c.isArray(d)&&Er(d)||c.isFileList(d)||c.endsWith(A,"[]")&&(S=c.toArray(d)))return A=at(A),S.forEach(function(te,bt){!(c.isUndefined(te)||te===null)&&e.append(o===!0?ct([A],bt,a):o===null?A:A+"[]",l(te))}),!1}return xe(d)?!0:(e.append(ct(y,A,a),l(d)),!1)}let _=[],L=Object.assign(pr,{defaultVisitor:E,convertValue:l,isVisitable:xe});function p(d,A){if(!c.isUndefined(d)){if(_.indexOf(d)!==-1)throw Error("Circular reference detected in "+A.join("."));_.push(d),c.forEach(d,function(S,x){(!(c.isUndefined(S)||S===null)&&i.call(e,S,c.isString(x)?x.trim():x,A,L))===!0&&p(S,A?A.concat(x):[x])}),_.pop()}}if(!c.isObject(r))throw new TypeError("data must be an object");return p(r),e}var P=Tr;function lt(r){let e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(r).replace(/[!'()~]|%20|%00/g,function(s){return e[s]})}function ut(r,e){this._pairs=[],r&&P(r,this,e)}var dt=ut.prototype;dt.append=function(e,t){this._pairs.push([e,t])};dt.toString=function(e){let t=e?function(s){return e.call(this,s,lt)}:lt;return this._pairs.map(function(i){return t(i[0])+"="+t(i[1])},"").join("&")};var me=ut;function _r(r){return encodeURIComponent(r).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function J(r,e,t){if(!e)return r;let s=t&&t.encode||_r,i=t&&t.serialize,a;if(i?a=i(e,t):a=c.isURLSearchParams(e)?e.toString():new me(e,t).toString(s),a){let o=r.indexOf("#");o!==-1&&(r=r.slice(0,o)),r+=(r.indexOf("?")===-1?"?":"&")+a}return r}var ht=class{constructor(){this.handlers=[]}use(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:s?s.synchronous:!1,runWhen:s?s.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){c.forEach(this.handlers,function(s){s!==null&&e(s)})}},Me=ht;var Te={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};var ft=typeof URLSearchParams!="undefined"?URLSearchParams:me;var Et=FormData;var Ar=(()=>{let r;return typeof navigator!="undefined"&&((r=navigator.product)==="ReactNative"||r==="NativeScript"||r==="NS")?!1:typeof window!="undefined"&&typeof document!="undefined"})(),R={isBrowser:!0,classes:{URLSearchParams:ft,FormData:Et,Blob},isStandardBrowserEnv:Ar,protocols:["http","https","file","blob","url","data"]};function Ve(r,e){return P(r,new R.classes.URLSearchParams,Object.assign({visitor:function(t,s,i,a){return R.isNode&&c.isBuffer(t)?(this.append(s,t.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function Lr(r){return c.matchAll(/\w+|\[(\w*)]/g,r).map(e=>e[0]==="[]"?"":e[1]||e[0])}function Rr(r){let e={},t=Object.keys(r),s,i=t.length,a;for(s=0;s<i;s++)a=t[s],e[a]=r[a];return e}function Ir(r){function e(t,s,i,a){let o=t[a++],u=Number.isFinite(+o),h=a>=t.length;return o=!o&&c.isArray(i)?i.length:o,h?(c.hasOwnProp(i,o)?i[o]=[i[o],s]:i[o]=s,!u):((!i[o]||!c.isObject(i[o]))&&(i[o]=[]),e(t,s,i[o],a)&&c.isArray(i[o])&&(i[o]=Rr(i[o])),!u)}if(c.isFormData(r)&&c.isFunction(r.entries)){let t={};return c.forEachEntry(r,(s,i)=>{e(Lr(s),i,t,0)}),t}return null}var _e=Ir;function Ye(r,e,t){let s=t.config.validateStatus;!t.status||!s||s(t.status)?r(t):e(new m("Request failed with status code "+t.status,[m.ERR_BAD_REQUEST,m.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}var pt=R.isStandardBrowserEnv?function(){return{write:function(t,s,i,a,o,u){let h=[];h.push(t+"="+encodeURIComponent(s)),c.isNumber(i)&&h.push("expires="+new Date(i).toGMTString()),c.isString(a)&&h.push("path="+a),c.isString(o)&&h.push("domain="+o),u===!0&&h.push("secure"),document.cookie=h.join("; ")},read:function(t){let s=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return s?decodeURIComponent(s[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}();function He(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}function Be(r,e){return e?r.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):r}function $(r,e){return r&&!He(e)?Be(r,e):e}var mt=R.isStandardBrowserEnv?function(){let e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a"),s;function i(a){let o=a;return e&&(t.setAttribute("href",o),o=t.href),t.setAttribute("href",o),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:t.pathname.charAt(0)==="/"?t.pathname:"/"+t.pathname}}return s=i(window.location.href),function(o){let u=c.isString(o)?i(o):o;return u.protocol===s.protocol&&u.host===s.host}}():function(){return function(){return!0}}();function Tt(r,e,t){m.call(this,r??"canceled",m.ERR_CANCELED,e,t),this.name="CanceledError"}c.inherits(Tt,m,{__CANCEL__:!0});var b=Tt;function ke(r){let e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(r);return e&&e[1]||""}var Sr=c.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),_t=r=>{let e={},t,s,i;return r&&r.split(`
`).forEach(function(o){i=o.indexOf(":"),t=o.substring(0,i).trim().toLowerCase(),s=o.substring(i+1).trim(),!(!t||e[t]&&Sr[t])&&(t==="set-cookie"?e[t]?e[t].push(s):e[t]=[s]:e[t]=e[t]?e[t]+", "+s:s)}),e};var At=Symbol("internals"),Lt=Symbol("defaults");function G(r){return r&&String(r).trim().toLowerCase()}function Ae(r){return r===!1||r==null?r:c.isArray(r)?r.map(Ae):String(r)}function Or(r){let e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,s;for(;s=t.exec(r);)e[s[1]]=s[2];return e}function Rt(r,e,t,s){if(c.isFunction(s))return s.call(this,e,t);if(!!c.isString(e)){if(c.isString(s))return e.indexOf(s)!==-1;if(c.isRegExp(s))return s.test(e)}}function Dr(r){return r.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,s)=>t.toUpperCase()+s)}function Cr(r,e){let t=c.toCamelCase(" "+e);["get","set","has"].forEach(s=>{Object.defineProperty(r,s+t,{value:function(i,a,o){return this[s].call(this,e,i,a,o)},configurable:!0})})}function W(r,e){e=e.toLowerCase();let t=Object.keys(r),s=t.length,i;for(;s-- >0;)if(i=t[s],e===i.toLowerCase())return i;return null}function B(r,e){r&&this.set(r),this[Lt]=e||null}Object.assign(B.prototype,{set:function(r,e,t){let s=this;function i(a,o,u){let h=G(o);if(!h)throw new Error("header name must be a non-empty string");let l=W(s,h);l&&u!==!0&&(s[l]===!1||u===!1)||(s[l||o]=Ae(a))}return c.isPlainObject(r)?c.forEach(r,(a,o)=>{i(a,o,e)}):i(e,r,t),this},get:function(r,e){if(r=G(r),!r)return;let t=W(this,r);if(t){let s=this[t];if(!e)return s;if(e===!0)return Or(s);if(c.isFunction(e))return e.call(this,s,t);if(c.isRegExp(e))return e.exec(s);throw new TypeError("parser must be boolean|regexp|function")}},has:function(r,e){if(r=G(r),r){let t=W(this,r);return!!(t&&(!e||Rt(this,this[t],t,e)))}return!1},delete:function(r,e){let t=this,s=!1;function i(a){if(a=G(a),a){let o=W(t,a);o&&(!e||Rt(t,t[o],o,e))&&(delete t[o],s=!0)}}return c.isArray(r)?r.forEach(i):i(r),s},clear:function(){return Object.keys(this).forEach(this.delete.bind(this))},normalize:function(r){let e=this,t={};return c.forEach(this,(s,i)=>{let a=W(t,i);if(a){e[a]=Ae(s),delete e[i];return}let o=r?Dr(i):String(i).trim();o!==i&&delete e[i],e[o]=Ae(s),t[o]=!0}),this},toJSON:function(r){let e=Object.create(null);return c.forEach(Object.assign({},this[Lt]||null,this),(t,s)=>{t==null||t===!1||(e[s]=r&&c.isArray(t)?t.join(", "):t)}),e}});Object.assign(B,{from:function(r){return c.isString(r)?new this(_t(r)):r instanceof this?r:new this(r)},accessor:function(r){let t=(this[At]=this[At]={accessors:{}}).accessors,s=this.prototype;function i(a){let o=G(a);t[o]||(Cr(s,a),t[o]=!0)}return c.isArray(r)?r.forEach(i):i(r),this}});B.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent"]);c.freezeMethods(B.prototype);c.freezeMethods(B);var D=B;function Nr(r,e){r=r||10;let t=new Array(r),s=new Array(r),i=0,a=0,o;return e=e!==void 0?e:1e3,function(h){let l=Date.now(),E=s[a];o||(o=l),t[i]=h,s[i]=l;let _=a,L=0;for(;_!==i;)L+=t[_++],_=_%r;if(i=(i+1)%r,i===a&&(a=(a+1)%r),l-o<e)return;let p=E&&l-E;return p?Math.round(L*1e3/p):void 0}}var It=Nr;function St(r,e){let t=0,s=It(50,250);return i=>{let a=i.loaded,o=i.lengthComputable?i.total:void 0,u=a-t,h=s(u),l=a<=o;t=a;let E={loaded:a,total:o,progress:o?a/o:void 0,bytes:u,rate:h||void 0,estimated:h&&o&&l?(o-a)/h:void 0};E[e?"download":"upload"]=!0,r(E)}}function K(r){return new Promise(function(t,s){let i=r.data,a=D.from(r.headers).normalize(),o=r.responseType,u;function h(){r.cancelToken&&r.cancelToken.unsubscribe(u),r.signal&&r.signal.removeEventListener("abort",u)}c.isFormData(i)&&R.isStandardBrowserEnv&&a.setContentType(!1);let l=new XMLHttpRequest;if(r.auth){let p=r.auth.username||"",d=r.auth.password?unescape(encodeURIComponent(r.auth.password)):"";a.set("Authorization","Basic "+btoa(p+":"+d))}let E=$(r.baseURL,r.url);l.open(r.method.toUpperCase(),J(E,r.params,r.paramsSerializer),!0),l.timeout=r.timeout;function _(){if(!l)return;let p=D.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders()),A={data:!o||o==="text"||o==="json"?l.responseText:l.response,status:l.status,statusText:l.statusText,headers:p,config:r,request:l};Ye(function(S){t(S),h()},function(S){s(S),h()},A),l=null}if("onloadend"in l?l.onloadend=_:l.onreadystatechange=function(){!l||l.readyState!==4||l.status===0&&!(l.responseURL&&l.responseURL.indexOf("file:")===0)||setTimeout(_)},l.onabort=function(){!l||(s(new m("Request aborted",m.ECONNABORTED,r,l)),l=null)},l.onerror=function(){s(new m("Network Error",m.ERR_NETWORK,r,l)),l=null},l.ontimeout=function(){let d=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded",A=r.transitional||Te;r.timeoutErrorMessage&&(d=r.timeoutErrorMessage),s(new m(d,A.clarifyTimeoutError?m.ETIMEDOUT:m.ECONNABORTED,r,l)),l=null},R.isStandardBrowserEnv){let p=(r.withCredentials||mt(E))&&r.xsrfCookieName&&pt.read(r.xsrfCookieName);p&&a.set(r.xsrfHeaderName,p)}i===void 0&&a.setContentType(null),"setRequestHeader"in l&&c.forEach(a.toJSON(),function(d,A){l.setRequestHeader(A,d)}),c.isUndefined(r.withCredentials)||(l.withCredentials=!!r.withCredentials),o&&o!=="json"&&(l.responseType=r.responseType),typeof r.onDownloadProgress=="function"&&l.addEventListener("progress",St(r.onDownloadProgress,!0)),typeof r.onUploadProgress=="function"&&l.upload&&l.upload.addEventListener("progress",St(r.onUploadProgress)),(r.cancelToken||r.signal)&&(u=p=>{!l||(s(!p||p.type?new b(null,r,l):p),l.abort(),l=null)},r.cancelToken&&r.cancelToken.subscribe(u),r.signal&&(r.signal.aborted?u():r.signal.addEventListener("abort",u)));let L=ke(E);if(L&&R.protocols.indexOf(L)===-1){s(new m("Unsupported protocol "+L+":",m.ERR_BAD_REQUEST,r));return}l.send(i||null)})}var Ot={http:K,xhr:K},je={getAdapter:r=>{if(c.isString(r)){let e=Ot[r];if(!r)throw Error(c.hasOwnProp(r)?`Adapter '${r}' is not available in the build`:`Can not resolve adapter '${r}'`);return e}if(!c.isFunction(r))throw new TypeError("adapter is not a function");return r},adapters:Ot};var Fr={"Content-Type":"application/x-www-form-urlencoded"};function Pr(){let r;return typeof XMLHttpRequest!="undefined"?r=je.getAdapter("xhr"):typeof process!="undefined"&&c.kindOf(process)==="process"&&(r=je.getAdapter("http")),r}function br(r,e,t){if(c.isString(r))try{return(e||JSON.parse)(r),c.trim(r)}catch(s){if(s.name!=="SyntaxError")throw s}return(t||JSON.stringify)(r)}var Le={transitional:Te,adapter:Pr(),transformRequest:[function(e,t){let s=t.getContentType()||"",i=s.indexOf("application/json")>-1,a=c.isObject(e);if(a&&c.isHTMLForm(e)&&(e=new FormData(e)),c.isFormData(e))return i&&i?JSON.stringify(_e(e)):e;if(c.isArrayBuffer(e)||c.isBuffer(e)||c.isStream(e)||c.isFile(e)||c.isBlob(e))return e;if(c.isArrayBufferView(e))return e.buffer;if(c.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let u;if(a){if(s.indexOf("application/x-www-form-urlencoded")>-1)return Ve(e,this.formSerializer).toString();if((u=c.isFileList(e))||s.indexOf("multipart/form-data")>-1){let h=this.env&&this.env.FormData;return P(u?{"files[]":e}:e,h&&new h,this.formSerializer)}}return a||i?(t.setContentType("application/json",!1),br(e)):e}],transformResponse:[function(e){let t=this.transitional||Le.transitional,s=t&&t.forcedJSONParsing,i=this.responseType==="json";if(e&&c.isString(e)&&(s&&!this.responseType||i)){let o=!(t&&t.silentJSONParsing)&&i;try{return JSON.parse(e)}catch(u){if(o)throw u.name==="SyntaxError"?m.from(u,m.ERR_BAD_RESPONSE,this,null,this.response):u}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:R.classes.FormData,Blob:R.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};c.forEach(["delete","get","head"],function(e){Le.headers[e]={}});c.forEach(["post","put","patch"],function(e){Le.headers[e]=c.merge(Fr)});var k=Le;function z(r,e){let t=this||k,s=e||t,i=D.from(s.headers),a=s.data;return c.forEach(r,function(u){a=u.call(t,a,i.normalize(),e?e.status:void 0)}),i.normalize(),a}function X(r){return!!(r&&r.__CANCEL__)}function ve(r){if(r.cancelToken&&r.cancelToken.throwIfRequested(),r.signal&&r.signal.aborted)throw new b}function Re(r){return ve(r),r.headers=D.from(r.headers),r.data=z.call(r,r.transformRequest),(r.adapter||k.adapter)(r).then(function(s){return ve(r),s.data=z.call(r,r.transformResponse,s),s.headers=D.from(s.headers),s},function(s){return X(s)||(ve(r),s&&s.response&&(s.response.data=z.call(r,r.transformResponse,s.response),s.response.headers=D.from(s.response.headers))),Promise.reject(s)})}function g(r,e){e=e||{};let t={};function s(l,E){return c.isPlainObject(l)&&c.isPlainObject(E)?c.merge(l,E):c.isPlainObject(E)?c.merge({},E):c.isArray(E)?E.slice():E}function i(l){if(c.isUndefined(e[l])){if(!c.isUndefined(r[l]))return s(void 0,r[l])}else return s(r[l],e[l])}function a(l){if(!c.isUndefined(e[l]))return s(void 0,e[l])}function o(l){if(c.isUndefined(e[l])){if(!c.isUndefined(r[l]))return s(void 0,r[l])}else return s(void 0,e[l])}function u(l){if(l in e)return s(r[l],e[l]);if(l in r)return s(void 0,r[l])}let h={url:a,method:a,data:a,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:u};return c.forEach(Object.keys(r).concat(Object.keys(e)),function(E){let _=h[E]||i,L=_(E);c.isUndefined(L)&&_!==u||(t[E]=L)}),t}var Ie="1.1.3";var qe={};["object","boolean","number","function","string","symbol"].forEach((r,e)=>{qe[r]=function(s){return typeof s===r||"a"+(e<1?"n ":" ")+r}});var Dt={};qe.transitional=function(e,t,s){function i(a,o){return"[Axios v"+Ie+"] Transitional option '"+a+"'"+o+(s?". "+s:"")}return(a,o,u)=>{if(e===!1)throw new m(i(o," has been removed"+(t?" in "+t:"")),m.ERR_DEPRECATED);return t&&!Dt[o]&&(Dt[o]=!0,console.warn(i(o," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(a,o,u):!0}};function gr(r,e,t){if(typeof r!="object")throw new m("options must be an object",m.ERR_BAD_OPTION_VALUE);let s=Object.keys(r),i=s.length;for(;i-- >0;){let a=s[i],o=e[a];if(o){let u=r[a],h=u===void 0||o(u,a,r);if(h!==!0)throw new m("option "+a+" must be "+h,m.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new m("Unknown option "+a,m.ERR_BAD_OPTION)}}var Se={assertOptions:gr,validators:qe};var U=Se.validators,Q=class{constructor(e){this.defaults=e,this.interceptors={request:new Me,response:new Me}}request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=g(this.defaults,t);let{transitional:s,paramsSerializer:i}=t;s!==void 0&&Se.assertOptions(s,{silentJSONParsing:U.transitional(U.boolean),forcedJSONParsing:U.transitional(U.boolean),clarifyTimeoutError:U.transitional(U.boolean)},!1),i!==void 0&&Se.assertOptions(i,{encode:U.function,serialize:U.function},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let a=t.headers&&c.merge(t.headers.common,t.headers[t.method]);a&&c.forEach(["delete","get","head","post","put","patch","common"],function(d){delete t.headers[d]}),t.headers=new D(t.headers,a);let o=[],u=!0;this.interceptors.request.forEach(function(d){typeof d.runWhen=="function"&&d.runWhen(t)===!1||(u=u&&d.synchronous,o.unshift(d.fulfilled,d.rejected))});let h=[];this.interceptors.response.forEach(function(d){h.push(d.fulfilled,d.rejected)});let l,E=0,_;if(!u){let p=[Re.bind(this),void 0];for(p.unshift.apply(p,o),p.push.apply(p,h),_=p.length,l=Promise.resolve(t);E<_;)l=l.then(p[E++],p[E++]);return l}_=o.length;let L=t;for(E=0;E<_;){let p=o[E++],d=o[E++];try{L=p(L)}catch(A){d.call(this,A);break}}try{l=Re.call(this,L)}catch(p){return Promise.reject(p)}for(E=0,_=h.length;E<_;)l=l.then(h[E++],h[E++]);return l}getUri(e){e=g(this.defaults,e);let t=$(e.baseURL,e.url);return J(t,e.params,e.paramsSerializer)}};c.forEach(["delete","get","head","options"],function(e){Q.prototype[e]=function(t,s){return this.request(g(s||{},{method:e,url:t,data:(s||{}).data}))}});c.forEach(["post","put","patch"],function(e){function t(s){return function(a,o,u){return this.request(g(u||{},{method:e,headers:s?{"Content-Type":"multipart/form-data"}:{},url:a,data:o}))}}Q.prototype[e]=t(),Q.prototype[e+"Form"]=t(!0)});var Z=Q;var Oe=class{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(a){t=a});let s=this;this.promise.then(i=>{if(!s._listeners)return;let a=s._listeners.length;for(;a-- >0;)s._listeners[a](i);s._listeners=null}),this.promise.then=i=>{let a,o=new Promise(u=>{s.subscribe(u),a=u}).then(i);return o.cancel=function(){s.unsubscribe(a)},o},e(function(a,o,u){s.reason||(s.reason=new b(a,o,u),t(s.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;let t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}static source(){let e;return{token:new Oe(function(i){e=i}),cancel:e}}},Ct=Oe;function Je(r){return function(t){return r.apply(null,t)}}function $e(r){return c.isObject(r)&&r.isAxiosError===!0}function Nt(r){let e=new Z(r),t=v(Z.prototype.request,e);return c.extend(t,Z.prototype,e,{allOwnKeys:!0}),c.extend(t,e,null,{allOwnKeys:!0}),t.create=function(i){return Nt(g(r,i))},t}var I=Nt(k);I.Axios=Z;I.CanceledError=b;I.CancelToken=Ct;I.isCancel=X;I.VERSION=Ie;I.toFormData=P;I.AxiosError=m;I.Cancel=I.CanceledError;I.all=function(e){return Promise.all(e)};I.spread=Je;I.isAxiosError=$e;I.formToJSON=r=>_e(c.isHTMLForm(r)?new FormData(r):r);var Ft=I;var Pt=Ft;var De=class{constructor(e,t){this.url=e,this.token=null,this.messageCallback=t}getCorrelationId(e){if(typeof e!="string")return null;var t;try{t=e&&JSON.parse(e)}catch{return null}if(t&&t[0]&&t[0][n.FIELD.CORRELATION_ID])return t[0][n.FIELD.CORRELATION_ID]}send(e){if(this.token===null)throw new Error("HTTP Connection not yet authenticated. Call authenticate() first.");Pt({url:this.url,method:"post",responseType:"json",responseEncoding:"utf8",headers:{Authorization:"Bearer "+this.token,"Content-Type":"application/json"},data:e}).then(t=>{e.includes(n.ACTION.SET)&&JSON.parse(e).forEach(i=>{i[n.FIELD.ACTION]===n.ACTION.SET&&t.data.push({[n.FIELD.CORRELATION_ID]:i[n.FIELD.CORRELATION_ID],[n.FIELD.RESULT]:n.RESULT.SUCCESS})}),this.messageCallback(t)}).catch(t=>{let s={[n.FIELD.RESULT]:n.RESULT.ERROR},i=this.getCorrelationId(e);i&&(s[n.FIELD.CORRELATION_ID]=i),t.response&&t.response.data?typeof t.response.data=="object"?(s[n.FIELD.ERROR]=t.response.data[n.FIELD.ERROR],s[n.FIELD.ERROR_CODE]=t.response.data[n.FIELD.ERROR_CODE]):s[n.FIELD.ERROR]=t.response.data:s[n.FIELD.ERROR]=t.message||t.body||t.toString(),this.messageCallback({data:[s]})})}close(){}};var ee=class extends N{constructor(e){super();this.constants=n,this.connectionStatus=n.CONNECTION_STATUS.DISCONNECTED,this.ping=null,this.version="1.11.0",this.serverVersion=null,this.serverBuildDate=null,this.mode=null,this.token=null,this.options=this._extendOptions(e,{outgoingMessageBufferTime:0,logMessages:!1,logErrors:!0,adminDashboardBasePath:"/admin/",heartbeatInterval:6e4,reconnectInterval:1e3,maxReconnectAttempts:1/0,httpRoot:null}),this.system=new re(this),this.realm=new de(this),this._subscription=new he(this),this._url=null,this._connection=null,this._reconnectTimeout=null,this._reconnectAttempts=0,this._onConnectPromise=null,this._onAuthenticatePromise=null,this._onDisconnectPromise=null,this._pendingRequests={},this._pendingMessages=null,this._pendingHeartbeats={},this._repeatOnReconnectMessages={},this._typeHandler={[n.TYPE.SYSTEM]:this.system,[n.TYPE.SUBSCRIPTION]:this._subscription,[n.TYPE.REALM]:this.realm}}useHTTP(e){if(this.mode==n.MODE.WS)throw new Error("Can't use HTTP. This client is already connected via Websocket.");clearInterval(this._heartbeatInterval),this.mode=n.MODE.HTTP,this._url=e,this._connection=new De(e,this._onMessage.bind(this))}connect(e){if(this.mode===n.MODE.HTTP)throw new Error("Can't connect via Websocket. This client is already using HTTP");if(this.mode===n.MODE.WS&&this._connection.readyState===this.WsConstructor.OPEN)throw new Error("This client is already connected");return this.mode=n.MODE.WS,this._url=e,this._changeConnectionStatus(n.CONNECTION_STATUS.CONNECTING),this._connection=new this.WsConstructor(e),this._connection.onopen=this._onOpen.bind(this),this._connection.onclose=this._onClose.bind(this),this._connection.onerror=t=>{this._onError(t.message,n.ERROR.CONNECTION_ERROR)},this._connection.onmessage=this._onMessage.bind(this),this._onConnectPromise||(this._onConnectPromise=w()),this._onConnectPromise}authenticate(e){return this._connection?this.mode===n.MODE.HTTP?(this._connection.token=e,this.connectionStatus=n.CONNECTION_STATUS.AUTHENTICATED,Promise.resolve()):(this.token=e,this.system._sendAuthMessage(e),this._onAuthenticatePromise=w(),this._onAuthenticatePromise):Promise.reject("can't authenticate: client not connected. Did you call .connect() before calling .authenticate()?")}disconnect(){return this._connection?(this._changeConnectionStatus(n.CONNECTION_STATUS.DISCONNECTING),this._connection.close(),this._onDisconnectPromise=w(),this._onDisconnectPromise):Promise.reject("client not connected")}getId(e){return e+"-"+be()}getURL(){return this._connection.url}_onOpen(){this._changeConnectionStatus(n.CONNECTION_STATUS.CONNECTED),clearInterval(this._heartbeatInterval),this._heartbeatInterval=setInterval(this._sendHeartbeatMessage.bind(this),this.options.heartbeatInterval),clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null,this._reconnectAttempts=0,this._onConnectPromise.resolve()}_onDisconnect(){clearInterval(this._heartbeatInterval),this._changeConnectionStatus(n.CONNECTION_STATUS.DISCONNECTED),this._onDisconnectPromise&&this._onDisconnectPromise.resolve()}_onClose(){if(this.connectionStatus===n.CONNECTION_STATUS.DISCONNECTING)this._onDisconnect();else{if(this._reconnectAttempts++,this._reconnectAttempts>this.options.maxReconnectAttempts){let t="exceeded max reconnect attempts. giving up :-(";this._onError(t,n.ERROR.MAX_RECONNECT_ATTEMPTS_EXCEEDED),clearTimeout(this._reconnectTimeout),this._onConnectPromise.reject(t),this._connection.close(),this._onDisconnect();return}let e=`Disconnected, attempting to reconnect. (Attempt ${this._reconnectAttempts} of ${this.options.maxReconnectAttempts})`;this._onError(e,n.ERROR.DISCONNECTED_RETRYING),clearTimeout(this._reconnectTimeout),this._changeConnectionStatus(n.CONNECTION_STATUS.DISCONNECTED),this._reconnectTimeout=setTimeout(async()=>{await this.connect(this._url),this.token&&await this.authenticate(this.token),this._sendRepeatOnReconnectMessages()},this.options.reconnectInterval)}}_onError(e,t,s){this.emit("error",e,t,s),this.options.logErrors&&console.warn(e,s||"")}_onMessage(e){var t;try{t=typeof e.data=="string"?JSON.parse(e.data):e.data}catch(s){this._onError(`Failed to parse message: ${s} - ${e.data}`,n.ERROR.MESSAGE_PARSE_ERROR)}Array.isArray(t)?t.forEach(this._handleIncomingMessage.bind(this)):this._onError(`message was not in expected form: ${JSON.stringify(t)}`,n.ERROR.MESSAGE_PARSE_ERROR)}_sendMessage(e){this._pendingMessages===null?(this._pendingMessages=[e],this.connectionStatus===n.CONNECTION_STATUS.AUTHENTICATED?this._sendPendingMessageTimeout=setTimeout(this._sendPendingMessages.bind(this),this.options.outgoingMessageBufferTime):this.options.logErrors&&console.warn("hivekit connection not authenticated. Outgoing messages will be queued until authentication")):this._pendingMessages.push(e)}_sendPendingMessages(){if(!(!this._pendingMessages||this._pendingMessages.length===0)){if(this.options.logMessages)for(let e=0;e<this._pendingMessages.length;e++)console.log(">",this._pendingMessages[e]);this._connection.send(JSON.stringify(this._pendingMessages)),this._pendingMessages=null}}_sendHeartbeatMessage(){if(this.connectionStatus!==n.CONNECTION_STATUS.AUTHENTICATED)return;let e=this.getId("heartbeat");this._pendingHeartbeats[e]=Date.now();let t=[{[n.FIELD.TYPE]:n.TYPE.SYSTEM,[n.FIELD.ACTION]:n.ACTION.HEARTBEAT,[n.FIELD.CORRELATION_ID]:e}];this._connection.send(JSON.stringify(t))}_processHeartbeatResponse(e){this._pendingHeartbeats[e[n.FIELD.CORRELATION_ID]]&&(this.ping=Date.now()-this._pendingHeartbeats[e[n.FIELD.CORRELATION_ID]],this.emit("ping",this.ping)),delete this._pendingHeartbeats[e[n.FIELD.CORRELATION_ID]]}_handleIncomingMessage(e){this.options.logMessages&&console.log("<",e),e[n.FIELD.CORRELATION_ID]?this._pendingHeartbeats[e[n.FIELD.CORRELATION_ID]]?this._processHeartbeatResponse(e):this._pendingRequests[e[n.FIELD.CORRELATION_ID]]?(this._pendingRequests[e[n.FIELD.CORRELATION_ID]].responseCallbacks.forEach(t=>{t(e)}),delete this._pendingRequests[e[n.FIELD.CORRELATION_ID]]):this._onError("Received response for unknown request",n.ERROR.UNKNOWN_REQUEST,e):e[n.FIELD.RESULT]===n.RESULT.ERROR&&e[n.FIELD.TYPE]!==n.TYPE.SYSTEM?this._onError(e[n.FIELD.ERROR]||e[n.FIELD.DATA],n.ERROR.SERVER_ERROR):this._typeHandler[e[n.FIELD.TYPE]]?this._typeHandler[e[n.FIELD.TYPE]]._handleIncomingMessage(e):this._onError("Received message for unknown type "+this._typeHandler[e[n.FIELD.TYPE]],n.ERROR.UNKNOWN_TYPE)}_changeConnectionStatus(e){this.connectionStatus=e,this.emit("connectionStatusChanged",e),e===n.CONNECTION_STATUS.AUTHENTICATED&&this._sendPendingMessages()}_sendRequest(e,t){let s=this._getSignature(e);for(let a in this._pendingRequests)if(this._pendingRequests[a].signature===s){this._pendingRequests[a].responseCallbacks.push(t);return}let i=be();e[n.FIELD.CORRELATION_ID]=i,this._pendingRequests[i]={signature:s,responseCallbacks:[t]},this._sendMessage(e)}_sendRequestAndHandleResponse(e,t){let s=w();return this._sendRequest(e,i=>{i[n.FIELD.RESULT]===n.RESULT.ERROR?(this._onError(i[n.FIELD.ERROR],n.FIELD.SERVER_ERROR,n.FIELD.ERROR_CODE),s.reject({message:i[n.FIELD.ERROR],code:i[n.FIELD.ERROR_CODE]})):s.resolve(t?t(i):i)}),s}_getSignature(...e){let t=JSON.stringify(e),s=0,i=0;for(s;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s),i=i&i;return i}_extendOptions(e,t,s){if(!e)return t;s&&(e=this._compressFields(e,s));let i={};for(let a in t)typeof e[a]!="undefined"?i[a]=e[a]:i[a]=t[a];return i}_extendFields(e,t=T.FIELD){let s={};for(let i in e)t[i]?i===n.FIELD.LOCATION?s[t[i]]=this._extendFields(e[i],T.LOCATION):i===n.FIELD.STEPS?s[t[i]]=this._extendFieldsArray(e[i],T.FIELD):i===n.FIELD.PRESENCE_CONNECTION_STATUS?s[t[n.FIELD.PRESENCE_CONNECTION_STATUS]]=T.PRESENCE_CONNECTION_STATUS[e[i]]:i===n.FIELD.SUB_TYPE&&e[n.FIELD.SHAPE]?s[t[n.FIELD.SHAPE]]=T.SHAPE_TYPE[e[i]]:i===n.FIELD.SHAPE?s[t[n.FIELD.SHAPE_DATA]]=e[i]:i===n.FIELD.TYPE?s[t[n.FIELD.TYPE]]=T.TYPE[e[i]]:i===n.FIELD.FIELD?s[t[n.FIELD.FIELD]]=T.FIELD[e[i]]:s[t[i]]=e[i]:s[i]=e[i];return s}_extendFieldsMap(e){let t={};for(let s in e)t[s]=this._extendFields(e[s]);return t}_extendFieldsArray(e){let t=[];for(let s of e)t.push(this._extendFields(s));return t}_compressFields(e,t,s){let i=Ge(t),a={};for(let o in e)i[o]?a[i[o]]=e[o]:s?a[o]=e[o]:this._onError(`Unknown field ${o}`,n.ERROR.UNKNOWN_FIELD);return a}_repeatOnReconnect(e,t,s,i){let a=`${e}-${t}-${s}`;this._repeatOnReconnectMessages[a]=i}_removeFromRepeatOnReconnect(e,t,s){let i=`${e}-${t}-${s}`;delete this._repeatOnReconnectMessages[i]}_sendRepeatOnReconnectMessages(){for(let e in this._repeatOnReconnectMessages)this._sendRequest(this._repeatOnReconnectMessages[e],()=>{});this._repeatOnReconnectMessages={}}};ee.prototype.WsConstructor=window.WebSocket;var Po=ee;export{Po as default};
